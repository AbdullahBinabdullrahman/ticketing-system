module.exports=[72172,e=>e.a(async(r,s)=>{try{var t=e.i(29229),a=e.i(88707),n=e.i(78156),i=e.i(89722),o=e.i(56732),d=e.i(3781),l=r([t,a,n,i]);async function u(e){try{let r,s,l,u,c,m=await a.db.select().from(n.roles).where((0,i.eq)(n.roles.id,e.roleId)).limit(1);if(0===m.length)return{success:!1,error:"Role not found"};if(!["admin","operational"].includes(m[0].name))return{success:!1,error:"Role must be admin or operational"};if((await a.db.select().from(n.users).where((0,i.and)((0,i.eq)(n.users.email,e.email),(0,i.eq)(n.users.isDeleted,!1))).limit(1)).length>0)return{success:!1,error:"Email already exists"};let g=e.password||(r="ABCDEFGHJKLMNPQRSTUVWXYZ",s="abcdefghjkmnpqrstuvwxyz",l="23456789",u="!@#$%&*",[(c=e=>e[Math.floor(Math.random()*e.length)])(r),c(s),c(l),c(u),...Array.from({length:8},()=>c(r+s+l+u))].sort(()=>Math.random()-.5).join("")),p=!e.password,h=await t.default.hash(g,12),f=await a.db.insert(n.users).values({name:e.name,email:e.email,phone:e.phone||null,password:h,roleId:e.roleId,userType:"admin",partnerId:null,languagePreference:e.language||"en",isActive:!0,isDeleted:!1,emailVerifiedAt:new Date,createdAt:new Date}).returning();if(!1!==e.sendWelcomeEmail&&p)try{await o.default.sendWelcomeEmail(e.email,e.name,g,e.language||"en"),d.logger.info("Welcome email sent to admin user",{email:e.email,userId:f[0].id})}catch(r){d.logger.error("Failed to send welcome email to admin user",{error:r,email:e.email})}return d.logger.info("Admin user created",{userId:f[0].id,email:e.email,role:m[0].name,passwordProvided:!p}),{success:!0,user:{id:f[0].id,name:f[0].name,email:f[0].email,phone:f[0].phone,roleId:f[0].roleId,roleName:m[0].name,userType:f[0].userType,languagePreference:f[0].languagePreference||"ar",isActive:f[0].isActive||!0,createdAt:f[0].createdAt},temporaryPassword:p?g:void 0}}catch(r){return d.logger.error("Error creating admin user",{error:r,input:e}),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}async function c(){try{let{partners:r}=await e.A(88377);return await a.db.select({id:n.users.id,name:n.users.name,email:n.users.email,phone:n.users.phone,roleId:n.users.roleId,roleName:n.roles.name,userType:n.users.userType,partnerId:n.users.partnerId,partnerName:r.name,languagePreference:n.users.languagePreference,isActive:n.users.isActive,lastLoginAt:n.users.lastLoginAt,emailVerifiedAt:n.users.emailVerifiedAt,createdAt:n.users.createdAt}).from(n.users).leftJoin(n.roles,(0,i.eq)(n.users.roleId,n.roles.id)).leftJoin(r,(0,i.eq)(n.users.partnerId,r.id)).where((0,i.eq)(n.users.isDeleted,!1)).orderBy(n.users.createdAt)}catch(e){throw d.logger.error("Error fetching all users",{error:e}),e}}async function m(e,r){try{let s=await a.db.select().from(n.users).where((0,i.and)((0,i.eq)(n.users.id,e),i.sql`${n.users.userType} = 'admin'::user_type_enum`,(0,i.eq)(n.users.isDeleted,!1))).limit(1);if(0===s.length)return{success:!1,error:"User not found or not an admin user"};if(r.email&&r.email!==s[0].email&&(await a.db.select().from(n.users).where((0,i.and)((0,i.eq)(n.users.email,r.email),(0,i.eq)(n.users.isDeleted,!1))).limit(1)).length>0)return{success:!1,error:"Email already exists"};let t=await a.db.update(n.users).set({...r,updatedAt:new Date}).where((0,i.eq)(n.users.id,e)).returning();return d.logger.info("Admin user updated",{userId:e,updates:r}),{success:!0,user:t[0]}}catch(s){return d.logger.error("Error updating admin user",{error:s,userId:e,updates:r}),{success:!1,error:s instanceof Error?s.message:"Unknown error"}}}async function g(e){try{let r=await a.db.update(n.users).set({isDeleted:!0,isActive:!1,updatedAt:new Date}).where((0,i.and)((0,i.eq)(n.users.id,e),i.sql`${n.users.userType} = 'admin'::user_type_enum`)).returning();if(0===r.length)return{success:!1,error:"User not found or not an admin user"};return d.logger.info("Admin user deleted (soft delete)",{userId:e}),{success:!0}}catch(r){return d.logger.error("Error deleting admin user",{error:r,userId:e}),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}async function p(){try{return await a.db.select().from(n.roles).where(i.sql`${n.roles.name} IN ('admin', 'operational')`)}catch(e){throw d.logger.error("Error fetching admin roles",{error:e}),e}}[t,a,n,i]=l.then?(await l)():l,e.s(["createAdminUser",()=>u,"deleteAdminUser",()=>g,"getAdminRoles",()=>p,"getAdminUsers",()=>c,"updateAdminUser",()=>m]),s()}catch(e){s(e)}},!1),61694,e=>e.a(async(r,s)=>{try{var t=e.i(11797),a=e.i(72172),n=e.i(88707),i=e.i(78156),o=e.i(89722),d=e.i(85278),l=e.i(3781),u=r([t,a,n,i,o,d]);async function c(e,r){try{let s=e.headers.authorization;if(!s||!s.startsWith("Bearer "))return(0,d.sendErrorResponse)(r,{message:"Authorization header missing or invalid",code:"AUTHENTICATION_ERROR",statusCode:401});let u=s.substring(7),{userId:c}=await t.authService.verifyToken(u),m=await t.authService.getUserProfile(c);if("admin"!==m.userType)return(0,d.sendErrorResponse)(r,{message:"Access denied - Admin required",code:"AUTHORIZATION_ERROR",statusCode:403});let{id:g}=e.query,p=parseInt(g);if(isNaN(p))return(0,d.sendErrorResponse)(r,{message:"Invalid user ID",code:"VALIDATION_ERROR",statusCode:400});if(l.logger.apiRequest(e.method,e.url,null,c,e.headers["x-request-id"]),"GET"===e.method){let s=await n.db.select({id:i.users.id,name:i.users.name,email:i.users.email,phone:i.users.phone,roleId:i.users.roleId,roleName:i.roles.name,userType:i.users.userType,partnerId:i.users.partnerId,languagePreference:i.users.languagePreference,isActive:i.users.isActive,lastLoginAt:i.users.lastLoginAt,emailVerifiedAt:i.users.emailVerifiedAt,createdAt:i.users.createdAt}).from(i.users).leftJoin(i.roles,(0,o.eq)(i.users.roleId,i.roles.id)).where((0,o.and)((0,o.eq)(i.users.id,p),(0,o.eq)(i.users.isDeleted,!1))).limit(1);if(0===s.length)return(0,d.sendErrorResponse)(r,{message:"User not found",code:"USER_NOT_FOUND",statusCode:404});return l.logger.apiResponse(e.method,e.url,200,0,c,e.headers["x-request-id"]),(0,d.sendSuccessResponse)(r,{user:s[0]},200)}if("PUT"===e.method){let s=e.body,t=await (0,a.updateAdminUser)(p,s);if(!t.success)return(0,d.sendErrorResponse)(r,{message:t.error||"Failed to update user",code:"USER_UPDATE_ERROR",statusCode:400});return l.logger.info("User updated",{userId:p,updatedBy:c,changes:s}),l.logger.apiResponse(e.method,e.url,200,0,c,e.headers["x-request-id"]),(0,d.sendSuccessResponse)(r,{user:t.user},200)}if("DELETE"===e.method){let s=await (0,a.deleteAdminUser)(p);if(!s.success)return(0,d.sendErrorResponse)(r,{message:s.error||"Failed to delete user",code:"USER_DELETE_ERROR",statusCode:400});return l.logger.info("User deleted (soft delete)",{userId:p,deletedBy:c}),l.logger.apiResponse(e.method,e.url,200,0,c,e.headers["x-request-id"]),(0,d.sendSuccessResponse)(r,{message:"User deleted successfully"},200)}return r.status(405).json({message:"Method not allowed"})}catch(t){let s=(0,d.handleApiError)(t);return l.logger.error("User management API error",{error:s.message,code:s.code,requestId:e.headers["x-request-id"]}),(0,d.sendErrorResponse)(r,s)}}[t,a,n,i,o,d]=u.then?(await u)():u,e.s(["default",()=>c]),s()}catch(e){s(e)}},!1),69949,e=>e.a(async(r,s)=>{try{var t=e.i(89304),a=e.i(36438),n=e.i(90950),i=e.i(17885),o=e.i(61694),d=e.i(8911),l=e.i(95011),u=e.i(40430),c=r([o]);[o]=c.then?(await c)():c;let g=(0,i.hoist)(o,"default"),p=(0,i.hoist)(o,"config"),h=new n.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/admin/users/[id]",pathname:"/api/admin/users/[id]",bundlePath:"",filename:""},userland:o,distDir:".next",relativeProjectDir:""});async function m(e,r,s){h.isDev&&(0,u.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/admin/users/[id]";a=a.replace(/\/index$/,"")||"/";let n=await h.prepare(e,r,{srcPage:a});if(!n){r.statusCode=400,r.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve());return}let{query:i,params:o,prerenderManifest:c,routerServerContext:m}=n;try{let s=e.method||"GET",t=(0,d.getTracer)(),n=t.getActiveScopeSpan(),u=h.instrumentationOnRequestError.bind(h),g=async n=>h.render(e,r,{query:{...i,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:h.isDev,page:"/api/admin/users/[id]",internalRevalidate:null==m?void 0:m.revalidate,onError:(...r)=>u(e,...r)}).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let e=t.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=e.get("next.route");if(i){let e=`${s} ${i}`;n.setAttributes({"next.route":i,"http.route":i,"next.span_name":e}),n.updateName(e)}else n.updateName(`${s} ${a}`)});n?await g(n):await t.withPropagatedContext(e.headers,()=>t.trace(l.BaseServerSpan.handleRequest,{spanName:`${s} ${a}`,kind:d.SpanKind.SERVER,attributes:{"http.method":s,"http.target":e.url}},g))}catch(e){if(h.isDev)throw e;(0,t.sendError)(r,500,"Internal Server Error")}finally{null==s.waitUntil||s.waitUntil.call(s,Promise.resolve())}}e.s(["config",0,p,"default",0,g,"handler",()=>m]),s()}catch(e){s(e)}},!1),88377,e=>{e.v(e=>Promise.resolve().then(()=>e(78156)))}];

//# sourceMappingURL=projects_ticketing-platform_7f0c3d6d._.js.map