module.exports=[72172,e=>e.a(async(r,t)=>{try{var s=e.i(29229),a=e.i(88707),n=e.i(78156),i=e.i(89722),o=e.i(56732),l=e.i(3781),d=r([s,a,n,i]);async function u(e){try{let r,t,d,u,m,c=await a.db.select().from(n.roles).where((0,i.eq)(n.roles.id,e.roleId)).limit(1);if(0===c.length)return{success:!1,error:"Role not found"};if(!["admin","operational"].includes(c[0].name))return{success:!1,error:"Role must be admin or operational"};if((await a.db.select().from(n.users).where((0,i.and)((0,i.eq)(n.users.email,e.email),(0,i.eq)(n.users.isDeleted,!1))).limit(1)).length>0)return{success:!1,error:"Email already exists"};let g=e.password||(r="ABCDEFGHJKLMNPQRSTUVWXYZ",t="abcdefghjkmnpqrstuvwxyz",d="23456789",u="!@#$%&*",[(m=e=>e[Math.floor(Math.random()*e.length)])(r),m(t),m(d),m(u),...Array.from({length:8},()=>m(r+t+d+u))].sort(()=>Math.random()-.5).join("")),p=!e.password,h=await s.default.hash(g,12),f=await a.db.insert(n.users).values({name:e.name,email:e.email,phone:e.phone||null,password:h,roleId:e.roleId,userType:"admin",partnerId:null,languagePreference:e.language||"en",isActive:!0,isDeleted:!1,emailVerifiedAt:new Date,createdAt:new Date}).returning();if(!1!==e.sendWelcomeEmail&&p)try{await o.default.sendWelcomeEmail(e.email,e.name,g,e.language||"en"),l.logger.info("Welcome email sent to admin user",{email:e.email,userId:f[0].id})}catch(r){l.logger.error("Failed to send welcome email to admin user",{error:r,email:e.email})}return l.logger.info("Admin user created",{userId:f[0].id,email:e.email,role:c[0].name,passwordProvided:!p}),{success:!0,user:{id:f[0].id,name:f[0].name,email:f[0].email,phone:f[0].phone,roleId:f[0].roleId,roleName:c[0].name,userType:f[0].userType,languagePreference:f[0].languagePreference||"ar",isActive:f[0].isActive||!0,createdAt:f[0].createdAt},temporaryPassword:p?g:void 0}}catch(r){return l.logger.error("Error creating admin user",{error:r,input:e}),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}async function m(){try{let{partners:r}=await e.A(88377);return await a.db.select({id:n.users.id,name:n.users.name,email:n.users.email,phone:n.users.phone,roleId:n.users.roleId,roleName:n.roles.name,userType:n.users.userType,partnerId:n.users.partnerId,partnerName:r.name,languagePreference:n.users.languagePreference,isActive:n.users.isActive,lastLoginAt:n.users.lastLoginAt,emailVerifiedAt:n.users.emailVerifiedAt,createdAt:n.users.createdAt}).from(n.users).leftJoin(n.roles,(0,i.eq)(n.users.roleId,n.roles.id)).leftJoin(r,(0,i.eq)(n.users.partnerId,r.id)).where((0,i.eq)(n.users.isDeleted,!1)).orderBy(n.users.createdAt)}catch(e){throw l.logger.error("Error fetching all users",{error:e}),e}}async function c(e,r){try{let t=await a.db.select().from(n.users).where((0,i.and)((0,i.eq)(n.users.id,e),i.sql`${n.users.userType} = 'admin'::user_type_enum`,(0,i.eq)(n.users.isDeleted,!1))).limit(1);if(0===t.length)return{success:!1,error:"User not found or not an admin user"};if(r.email&&r.email!==t[0].email&&(await a.db.select().from(n.users).where((0,i.and)((0,i.eq)(n.users.email,r.email),(0,i.eq)(n.users.isDeleted,!1))).limit(1)).length>0)return{success:!1,error:"Email already exists"};let s=await a.db.update(n.users).set({...r,updatedAt:new Date}).where((0,i.eq)(n.users.id,e)).returning();return l.logger.info("Admin user updated",{userId:e,updates:r}),{success:!0,user:s[0]}}catch(t){return l.logger.error("Error updating admin user",{error:t,userId:e,updates:r}),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}async function g(e){try{let r=await a.db.update(n.users).set({isDeleted:!0,isActive:!1,updatedAt:new Date}).where((0,i.and)((0,i.eq)(n.users.id,e),i.sql`${n.users.userType} = 'admin'::user_type_enum`)).returning();if(0===r.length)return{success:!1,error:"User not found or not an admin user"};return l.logger.info("Admin user deleted (soft delete)",{userId:e}),{success:!0}}catch(r){return l.logger.error("Error deleting admin user",{error:r,userId:e}),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}async function p(){try{return await a.db.select().from(n.roles).where(i.sql`${n.roles.name} IN ('admin', 'operational')`)}catch(e){throw l.logger.error("Error fetching admin roles",{error:e}),e}}[s,a,n,i]=d.then?(await d)():d,e.s(["createAdminUser",()=>u,"deleteAdminUser",()=>g,"getAdminRoles",()=>p,"getAdminUsers",()=>m,"updateAdminUser",()=>c]),t()}catch(e){t(e)}},!1),35942,e=>e.a(async(r,t)=>{try{var s=e.i(11797),a=e.i(72172),n=e.i(85278),i=e.i(3781),o=e.i(97010),l=r([s,a,n,o]);[s,a,n,o]=l.then?(await l)():l;let u=o.z.object({name:o.z.string().min(2,"Name must be at least 2 characters"),email:o.z.string().email("Invalid email address"),phone:o.z.string().optional(),roleId:o.z.number().int().positive("Role ID is required"),language:o.z.enum(["en","ar"]).optional(),sendWelcomeEmail:o.z.boolean().optional()});async function d(e,r){try{let t=e.headers.authorization;if(!t||!t.startsWith("Bearer "))return(0,n.sendErrorResponse)(r,{message:"Authorization header missing or invalid",code:"AUTHENTICATION_ERROR",statusCode:401});let o=t.substring(7),{userId:l}=await s.authService.verifyToken(o),d=await s.authService.getUserProfile(l);if("admin"!==d.userType)return(0,n.sendErrorResponse)(r,{message:"Access denied - Admin required",code:"AUTHORIZATION_ERROR",statusCode:403});if("GET"===e.method){let t=await (0,a.getAdminUsers)(),s=await (0,a.getAdminRoles)();return i.logger.apiResponse(e.method,e.url,200,0,l,e.headers["x-request-id"]),(0,n.sendSuccessResponse)(r,{users:t,roles:s},200)}if("POST"===e.method){let t=u.parse(e.body),s=await (0,a.createAdminUser)({name:t.name,email:t.email,phone:t.phone,roleId:t.roleId,language:t.language||"en",sendWelcomeEmail:!1!==t.sendWelcomeEmail});if(!s.success)return(0,n.sendErrorResponse)(r,{message:s.error||"Failed to create user",code:"USER_CREATION_ERROR",statusCode:400});return i.logger.info("Admin user created",{userId:s.user?.id,createdBy:l,email:t.email}),i.logger.apiResponse(e.method,e.url,201,0,l,e.headers["x-request-id"]),(0,n.sendSuccessResponse)(r,{user:s.user,temporaryPassword:s.temporaryPassword},201)}return r.status(405).json({message:"Method not allowed"})}catch(s){let t=(0,n.handleApiError)(s);return i.logger.error("Admin users API error",{error:t.message,code:t.code,requestId:e.headers["x-request-id"]}),(0,n.sendErrorResponse)(r,t)}}e.s(["default",()=>d]),t()}catch(e){t(e)}},!1),81657,e=>e.a(async(r,t)=>{try{var s=e.i(89304),a=e.i(36438),n=e.i(90950),i=e.i(17885),o=e.i(35942),l=e.i(8911),d=e.i(95011),u=e.i(40430),m=r([o]);[o]=m.then?(await m)():m;let g=(0,i.hoist)(o,"default"),p=(0,i.hoist)(o,"config"),h=new n.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/admin/users",pathname:"/api/admin/users",bundlePath:"",filename:""},userland:o,distDir:".next",relativeProjectDir:""});async function c(e,r,t){h.isDev&&(0,u.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/admin/users";a=a.replace(/\/index$/,"")||"/";let n=await h.prepare(e,r,{srcPage:a});if(!n){r.statusCode=400,r.end("Bad Request"),null==t.waitUntil||t.waitUntil.call(t,Promise.resolve());return}let{query:i,params:o,prerenderManifest:m,routerServerContext:c}=n;try{let t=e.method||"GET",s=(0,l.getTracer)(),n=s.getActiveScopeSpan(),u=h.instrumentationOnRequestError.bind(h),g=async n=>h.render(e,r,{query:{...i,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:m.preview,propagateError:!1,dev:h.isDev,page:"/api/admin/users",internalRevalidate:null==c?void 0:c.revalidate,onError:(...r)=>u(e,...r)}).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let e=s.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=e.get("next.route");if(i){let e=`${t} ${i}`;n.setAttributes({"next.route":i,"http.route":i,"next.span_name":e}),n.updateName(e)}else n.updateName(`${t} ${a}`)});n?await g(n):await s.withPropagatedContext(e.headers,()=>s.trace(d.BaseServerSpan.handleRequest,{spanName:`${t} ${a}`,kind:l.SpanKind.SERVER,attributes:{"http.method":t,"http.target":e.url}},g))}catch(e){if(h.isDev)throw e;(0,s.sendError)(r,500,"Internal Server Error")}finally{null==t.waitUntil||t.waitUntil.call(t,Promise.resolve())}}e.s(["config",0,p,"default",0,g,"handler",()=>c]),t()}catch(e){t(e)}},!1),88377,e=>{e.v(e=>Promise.resolve().then(()=>e(78156)))}];

//# sourceMappingURL=projects_ticketing-platform_b5c26a48._.js.map