module.exports=[64219,e=>e.a(async(t,r)=>{try{var s=e.i(11797),a=e.i(88707),n=e.i(78156),i=e.i(89722),o=e.i(85278),u=e.i(3781),d=t([s,a,n,i,o]);async function c(e,t){if("GET"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let r=e.headers.authorization;if(!r||!r.startsWith("Bearer "))return(0,o.sendErrorResponse)(t,{message:"Authorization header missing or invalid",code:"AUTHENTICATION_ERROR",statusCode:401});let d=r.substring(7),{userId:c}=await s.authService.verifyToken(d),l=await s.authService.getUserProfile(c);if("partner"!==l.userType||!l.partnerId)return(0,o.sendErrorResponse)(t,{message:"Access denied - Partner required",code:"AUTHORIZATION_ERROR",statusCode:403});let p=l.partnerId,m=e.query.id,h=m.startsWith("REQ-"),g=h?null:parseInt(m);if(!h&&isNaN(g))return(0,o.sendErrorResponse)(t,{message:"Invalid request ID",code:"VALIDATION_ERROR",statusCode:400});let q=[(0,i.eq)(n.requests.partnerId,p),(0,i.eq)(n.requests.isDeleted,!1)];h?q.push((0,i.eq)(n.requests.requestNumber,m)):q.push((0,i.eq)(n.requests.id,g));let f=await a.db.select({id:n.requests.id,requestNumber:n.requests.requestNumber,status:n.requests.status,pickupOptionId:n.requests.pickupOptionId,customerLat:n.requests.customerLat,customerLng:n.requests.customerLng,customerAddress:n.requests.customerAddress,rating:n.requests.rating,feedback:n.requests.feedback,createdAt:n.requests.createdAt,assignedAt:n.requests.assignedAt,confirmedAt:n.requests.confirmedAt,completedAt:n.requests.completedAt,customerId:n.customers.id,customerName:n.users.name,customerEmail:n.users.email,customerPhone:n.customers.phone,serviceId:n.services.id,serviceName:n.services.name,serviceNameAr:n.services.nameAr,categoryId:n.categories.id,categoryName:n.categories.name,categoryNameAr:n.categories.nameAr,branchId:n.branches.id,branchName:n.branches.name,branchAddress:n.branches.address,branchLat:n.branches.lat,branchLng:n.branches.lng,branchPhone:n.branches.phone,partnerName:n.partners.name,partnerLogoUrl:n.partners.logoUrl}).from(n.requests).leftJoin(n.users,(0,i.eq)(n.requests.customerId,n.users.id)).leftJoin(n.customers,(0,i.eq)(n.users.id,n.customers.userId)).leftJoin(n.services,(0,i.eq)(n.requests.serviceId,n.services.id)).leftJoin(n.categories,(0,i.eq)(n.services.categoryId,n.categories.id)).leftJoin(n.branches,(0,i.eq)(n.requests.branchId,n.branches.id)).leftJoin(n.partners,(0,i.eq)(n.requests.partnerId,n.partners.id)).where((0,i.and)(...q)).limit(1);if(0===f.length)throw new o.AppError("Request not found or access denied",404,o.ErrorCodes.REQUEST_NOT_FOUND);let v=f[0],A=await a.db.select({id:n.requestStatusLog.id,status:n.requestStatusLog.status,changedById:n.requestStatusLog.changedById,changedByName:n.users.name,notes:n.requestStatusLog.notes,timestamp:n.requestStatusLog.timestamp}).from(n.requestStatusLog).leftJoin(n.users,(0,i.eq)(n.requestStatusLog.changedById,n.users.id)).where((0,i.eq)(n.requestStatusLog.requestId,v.id)).orderBy((0,i.desc)(n.requestStatusLog.timestamp)),I=null;if("assigned"===v.status&&v.assignedAt){let e=new Date(v.assignedAt).getTime(),t=Date.now();I=Math.max(0,Math.floor((9e5-(t-e))/6e4))}return u.logger.apiResponse(e.method,e.url,200,0,c,e.headers["x-request-id"]),(0,o.sendSuccessResponse)(t,{request:v,timeline:A,timeRemainingMinutes:I})}catch(s){let r=(0,o.handleApiError)(s);return u.logger.error("Partner request detail API error",{error:r.message,code:r.code,requestId:e.headers["x-request-id"]}),(0,o.sendErrorResponse)(t,r)}}[s,a,n,i,o]=d.then?(await d)():d,e.s(["default",()=>c]),r()}catch(e){r(e)}},!1),99251,e=>e.a(async(t,r)=>{try{var s=e.i(89304),a=e.i(36438),n=e.i(90950),i=e.i(17885),o=e.i(64219),u=e.i(8911),d=e.i(95011),c=e.i(40430),l=t([o]);[o]=l.then?(await l)():l;let m=(0,i.hoist)(o,"default"),h=(0,i.hoist)(o,"config"),g=new n.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/partner/requests/[id]",pathname:"/api/partner/requests/[id]",bundlePath:"",filename:""},userland:o,distDir:".next",relativeProjectDir:""});async function p(e,t,r){g.isDev&&(0,c.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/partner/requests/[id]";a=a.replace(/\/index$/,"")||"/";let n=await g.prepare(e,t,{srcPage:a});if(!n){t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:i,params:o,prerenderManifest:l,routerServerContext:p}=n;try{let r=e.method||"GET",s=(0,u.getTracer)(),n=s.getActiveScopeSpan(),c=g.instrumentationOnRequestError.bind(g),m=async n=>g.render(e,t,{query:{...i,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:l.preview,propagateError:!1,dev:g.isDev,page:"/api/partner/requests/[id]",internalRevalidate:null==p?void 0:p.revalidate,onError:(...t)=>c(e,...t)}).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=s.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=e.get("next.route");if(i){let e=`${r} ${i}`;n.setAttributes({"next.route":i,"http.route":i,"next.span_name":e}),n.updateName(e)}else n.updateName(`${r} ${a}`)});n?await m(n):await s.withPropagatedContext(e.headers,()=>s.trace(d.BaseServerSpan.handleRequest,{spanName:`${r} ${a}`,kind:u.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},m))}catch(e){if(g.isDev)throw e;(0,s.sendError)(t,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,h,"default",0,m,"handler",()=>p]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=projects_ticketing-platform_b2290829._.js.map