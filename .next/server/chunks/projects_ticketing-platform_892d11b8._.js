module.exports=[60266,e=>e.a(async(t,s)=>{try{var r=e.i(11797),a=e.i(85278),n=e.i(3781),u=e.i(78156),o=e.i(89722),i=e.i(88707),d=t([r,a,u,o,i]);async function c(e,t){if("GET"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let s=e.headers.authorization;if(!s||!s.startsWith("Bearer "))return(0,a.sendErrorResponse)(t,{message:"Authorization header missing or invalid",code:"AUTHENTICATION_ERROR",statusCode:401});let d=s.substring(7),{userId:c}=await r.authService.verifyToken(d),l=await r.authService.getUserProfile(c);if("admin"!==l.userType)return(0,a.sendErrorResponse)(t,{message:"Access denied - Admin required",code:"AUTHORIZATION_ERROR",statusCode:403});let m=new Date,q=new Date(m.getFullYear(),m.getMonth(),m.getDate()),p=new Date(m.getTime()-2592e6),g=new Date(m.getTime()-5184e6),[h,f,b,w,A,N,v,I,y,R,_,$,E,S,x,T]=await Promise.all([i.db.select({count:(0,o.count)()}).from(u.requests),i.db.select({count:(0,o.count)()}).from(u.requests).where(o.sql`${u.requests.status} IN ('assigned'::request_status_enum, 'confirmed'::request_status_enum, 'in_progress'::request_status_enum)`),i.db.select({count:(0,o.count)()}).from(u.requests).where(o.sql`${u.requests.status} IN ('submitted'::request_status_enum, 'unassigned'::request_status_enum)`),i.db.select({count:(0,o.count)()}).from(u.requests).where(o.sql`${u.requests.status} IN ('completed'::request_status_enum, 'closed'::request_status_enum)`),i.db.select({count:(0,o.count)()}).from(u.requests).where((0,o.and)(o.sql`${u.requests.status} IN ('completed'::request_status_enum, 'closed'::request_status_enum)`,(0,o.gte)(u.requests.completedAt,q))),i.db.select({count:(0,o.count)()}).from(u.requests).where(o.sql`${u.requests.assignedAt} IS NOT NULL 
          AND ${u.requests.submittedAt} IS NOT NULL 
          AND EXTRACT(EPOCH FROM (${u.requests.assignedAt} - ${u.requests.submittedAt}))/60 > 15`),i.db.select({count:(0,o.count)()}).from(u.partners),i.db.select({count:(0,o.count)()}).from(u.partners).where(o.sql`${u.partners.status} = 'active'::partner_status_enum`),i.db.select({count:(0,o.count)()}).from(u.branches).where((0,o.eq)(u.branches.isActive,!0)),i.db.select({avg:o.sql`COALESCE(AVG(${u.requests.rating}), 0)`}).from(u.requests).where(o.sql`${u.requests.rating} IS NOT NULL`),i.db.select({count:(0,o.count)()}).from(u.requests).where((0,o.gte)(u.requests.createdAt,p)),i.db.select({count:(0,o.count)()}).from(u.requests).where((0,o.and)((0,o.gte)(u.requests.createdAt,g),o.sql`${u.requests.createdAt} < ${p.toISOString()}`)),i.db.select({id:u.requests.id,customerName:u.requests.customerName,customerPhone:u.requests.customerPhone,status:u.requests.status,createdAt:u.requests.createdAt,categoryId:u.requests.categoryId}).from(u.requests).orderBy((0,o.desc)(u.requests.createdAt)).limit(10),i.db.select({partnerId:u.requests.partnerId,partnerName:u.partners.name,completedCount:(0,o.count)(),avgRating:o.sql`COALESCE(AVG(${u.requests.rating}), 0)`}).from(u.requests).innerJoin(u.partners,(0,o.eq)(u.requests.partnerId,u.partners.id)).where(o.sql`${u.requests.status} IN ('completed'::request_status_enum, 'closed'::request_status_enum) AND ${u.requests.partnerId} IS NOT NULL`).groupBy(u.requests.partnerId,u.partners.name).orderBy((0,o.desc)((0,o.count)())).limit(5),i.db.select({status:u.requests.status,count:(0,o.count)()}).from(u.requests).groupBy(u.requests.status),i.db.select({categoryId:u.requests.categoryId,count:(0,o.count)()}).from(u.requests).where(o.sql`${u.requests.categoryId} IS NOT NULL`).groupBy(u.requests.categoryId).limit(5)]),P=h[0]?.count||0,D=f[0]?.count||0,O=b[0]?.count||0,C=w[0]?.count||0,U=A[0]?.count||0,L=N[0]?.count||0,B=v[0]?.count||0,M=I[0]?.count||0,F=y[0]?.count||0,G=Number(R[0]?.avg||0),H=_[0]?.count||0,j=$[0]?.count||1,k=P>0?(C/P*100).toFixed(1):0,K=j>0?((H-j)/j*100).toFixed(1):0,V={totalRequests:P,pendingRequests:D,unassignedRequests:O,completedRequests:C,todayCompleted:U,slaBreaches:L,totalPartners:B,activePartners:M,activeBranches:F,averageRating:Number(G.toFixed(1)),completionRate:Number(k),requestsGrowth:Number(K),last30DaysCount:H,recentRequests:E.map(e=>({id:e.id,customerName:e.customerName,customerPhone:e.customerPhone,status:e.status,createdAt:e.createdAt,timeAgo:function(e){if(!e)return"Unknown";let t=new Date().getTime()-new Date(e).getTime(),s=Math.floor(t/6e4),r=Math.floor(t/36e5),a=Math.floor(t/864e5);return s<1?"Just now":s<60?`${s} minute${s>1?"s":""} ago`:r<24?`${r} hour${r>1?"s":""} ago`:`${a} day${a>1?"s":""} ago`}(e.createdAt)})),topPartners:S.map(e=>{var t;return{partnerId:e.partnerId,name:e.partnerName,completedRequests:e.completedCount,rating:e?.avgRating?Number(Number(e.avgRating).toFixed(1)):0,status:(t=Number(e.avgRating||0))>=4.5?"Excellent":t>=4?"Good":t>=3.5?"Average":"Poor"}}),requestsByStatus:x.map(e=>({status:e.status,count:e.count,percentage:P>0?(e.count/P*100).toFixed(1):0})),requestsByCategory:T.map(e=>({categoryId:e.categoryId,count:e.count,percentage:P>0?(e.count/P*100).toFixed(1):0}))};return n.logger.apiResponse(e.method,e.url,200,0,c,e.headers["x-request-id"]),(0,a.sendSuccessResponse)(t,V)}catch(r){let s=(0,a.handleApiError)(r);return n.logger.error("Dashboard stats API error",{error:s.message,code:s.code,requestId:e.headers["x-request-id"]}),(0,a.sendErrorResponse)(t,s)}}[r,a,u,o,i]=d.then?(await d)():d,e.s(["default",()=>c]),s()}catch(e){s(e)}},!1),7899,e=>e.a(async(t,s)=>{try{var r=e.i(89304),a=e.i(36438),n=e.i(90950),u=e.i(17885),o=e.i(60266),i=e.i(8911),d=e.i(95011),c=e.i(40430),l=t([o]);[o]=l.then?(await l)():l;let q=(0,u.hoist)(o,"default"),p=(0,u.hoist)(o,"config"),g=new n.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/admin/dashboard/stats",pathname:"/api/admin/dashboard/stats",bundlePath:"",filename:""},userland:o,distDir:".next",relativeProjectDir:""});async function m(e,t,s){g.isDev&&(0,c.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/admin/dashboard/stats";a=a.replace(/\/index$/,"")||"/";let n=await g.prepare(e,t,{srcPage:a});if(!n){t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve());return}let{query:u,params:o,prerenderManifest:l,routerServerContext:m}=n;try{let s=e.method||"GET",r=(0,i.getTracer)(),n=r.getActiveScopeSpan(),c=g.instrumentationOnRequestError.bind(g),q=async n=>g.render(e,t,{query:{...u,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:l.preview,propagateError:!1,dev:g.isDev,page:"/api/admin/dashboard/stats",internalRevalidate:null==m?void 0:m.revalidate,onError:(...t)=>c(e,...t)}).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=r.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let u=e.get("next.route");if(u){let e=`${s} ${u}`;n.setAttributes({"next.route":u,"http.route":u,"next.span_name":e}),n.updateName(e)}else n.updateName(`${s} ${a}`)});n?await q(n):await r.withPropagatedContext(e.headers,()=>r.trace(d.BaseServerSpan.handleRequest,{spanName:`${s} ${a}`,kind:i.SpanKind.SERVER,attributes:{"http.method":s,"http.target":e.url}},q))}catch(e){if(g.isDev)throw e;(0,r.sendError)(t,500,"Internal Server Error")}finally{null==s.waitUntil||s.waitUntil.call(s,Promise.resolve())}}e.s(["config",0,p,"default",0,q,"handler",()=>m]),s()}catch(e){s(e)}},!1)];

//# sourceMappingURL=projects_ticketing-platform_892d11b8._.js.map