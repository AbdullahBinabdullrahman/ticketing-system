module.exports=[23268,e=>e.a(async(r,t)=>{try{var i=e.i(88707),n=e.i(78156),o=e.i(89722),a=e.i(3781),s=r([i,n,o]);[i,n,o]=s.then?(await s)():s;let l={SLA_TIMEOUT_MINUTES:"sla_timeout_minutes",OPERATIONAL_TEAM_EMAILS:"operational_team_emails",ADMIN_NOTIFICATION_EMAILS:"admin_notification_emails"};class u{async getGlobalConfig(e){try{let r=await i.db.select({id:n.configurations.id,key:n.configurations.key,value:n.configurations.value,description:n.configurations.description,updatedAt:n.configurations.updatedAt}).from(n.configurations).where((0,o.and)(o.sql`${n.configurations.scope} = 'global'::config_scope_enum`,(0,o.eq)(n.configurations.key,e),(0,o.eq)(n.configurations.isActive,!0),(0,o.eq)(n.configurations.isDeleted,!1))).limit(1);if(0===r.length)return a.logger.debug(`Configuration not found: ${e}`),null;return r[0]}catch(r){throw a.logger.error("Error fetching global config",{key:e,error:r}),r}}async setGlobalConfig(e,r,t,s){try{let l=await i.db.select().from(n.configurations).where((0,o.and)(o.sql`${n.configurations.scope} = 'global'::config_scope_enum`,(0,o.eq)(n.configurations.key,e),(0,o.eq)(n.configurations.isDeleted,!1))).limit(1);if(l.length>0){let u=await i.db.update(n.configurations).set({value:r,description:t||l[0].description,updatedAt:new Date,updatedById:s,isActive:!0}).where((0,o.eq)(n.configurations.id,l[0].id)).returning({id:n.configurations.id,key:n.configurations.key,value:n.configurations.value,description:n.configurations.description,updatedAt:n.configurations.updatedAt});return a.logger.info("Configuration updated",{key:e,userId:s}),u[0]}{let o=await i.db.insert(n.configurations).values({scope:"global",key:e,value:r,description:t||null,createdById:s,updatedById:s,isActive:!0,isDeleted:!1}).returning({id:n.configurations.id,key:n.configurations.key,value:n.configurations.value,description:n.configurations.description,updatedAt:n.configurations.updatedAt});return a.logger.info("Configuration created",{key:e,userId:s}),o[0]}}catch(r){throw a.logger.error("Error setting global config",{key:e,error:r}),r}}async getAllGlobalConfigs(){try{return await i.db.select({id:n.configurations.id,key:n.configurations.key,value:n.configurations.value,description:n.configurations.description,updatedAt:n.configurations.updatedAt}).from(n.configurations).where((0,o.and)(o.sql`${n.configurations.scope} = 'global'::config_scope_enum`,(0,o.eq)(n.configurations.isActive,!0),(0,o.eq)(n.configurations.isDeleted,!1))).orderBy(n.configurations.key)}catch(e){throw a.logger.error("Error fetching all global configs",{error:e}),e}}async deleteGlobalConfig(e,r){try{await i.db.update(n.configurations).set({isDeleted:!0,updatedAt:new Date,updatedById:r}).where((0,o.and)(o.sql`${n.configurations.scope} = 'global'::config_scope_enum`,(0,o.eq)(n.configurations.key,e))),a.logger.info("Configuration deleted",{key:e,userId:r})}catch(r){throw a.logger.error("Error deleting global config",{key:e,error:r}),r}}async getSlaTimeout(){try{let e=await this.getGlobalConfig(l.SLA_TIMEOUT_MINUTES);if(e&&e.value){let r=parseInt(e.value,10);if(!isNaN(r)&&r>0&&r<=60)return r}let r=parseInt(process.env.DEFAULT_SLA_TIMEOUT_MINUTES||"15",10);return isNaN(r)?15:r}catch(e){return a.logger.error("Error getting SLA timeout, using default",{error:e}),15}}async getOperationalTeamEmails(){try{let e=await this.getGlobalConfig(l.OPERATIONAL_TEAM_EMAILS);if(e&&e.value)return e.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);let r=process.env.OPERATIONAL_TEAM_EMAILS||"";if(r)return r.split(",").map(e=>e.trim()).filter(e=>e.length>0);return[]}catch(e){return a.logger.error("Error getting operational team emails",{error:e}),[]}}async getAdminEmails(){try{let e=await i.db.select({email:n.users.email,name:n.users.name,roleName:n.roles.name}).from(n.users).innerJoin(n.roles,(0,o.eq)(n.users.roleId,n.roles.id)).where((0,o.and)((0,o.or)((0,o.eq)(n.users.userType,"admin"),(0,o.inArray)(n.roles.name,["admin","operation"])),(0,o.eq)(n.users.isActive,!0),(0,o.eq)(n.users.isDeleted,!1),(0,o.eq)(n.roles.isActive,!0),(0,o.eq)(n.roles.isDeleted,!1))),r=[...new Set(e.map(e=>e.email))];if(r.length>0)return a.logger.info("Retrieved admin emails from database",{count:r.length,emails:r.map(e=>e.replace(/^(.{3}).*(@.*)$/,"$1***$2"))}),r;let t=await this.getGlobalConfig(l.ADMIN_NOTIFICATION_EMAILS);if(t&&t.value){let e=t.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);if(e.length>0)return a.logger.info("Using admin emails from config",{count:e.length}),e}let s=process.env.ADMIN_EMAIL||"";if(s)return a.logger.info("Using admin email from environment variable"),[s];return a.logger.warn("No admin emails found in database, config, or environment"),[]}catch(r){a.logger.error("Error getting admin emails",{error:r instanceof Error?r.message:"Unknown error",stack:r instanceof Error?r.stack:void 0});let e=process.env.ADMIN_EMAIL||"";if(e)return a.logger.info("Using emergency fallback to environment variable"),[e];return[]}}async getSlaNotificationRecipients(){try{let e=await this.getAdminEmails(),r=await this.getOperationalTeamEmails(),t=[...e,...r];return Array.from(new Set(t))}catch(e){return a.logger.error("Error getting SLA notification recipients",{error:e}),[]}}}let d=new u;e.s(["CONFIG_KEYS",0,l,"ConfigurationService",()=>u,"configurationService",0,d]),t()}catch(e){t(e)}},!1),60901,e=>e.a(async(r,t)=>{try{var i=e.i(11797),n=e.i(88707),o=e.i(78156),a=e.i(89722),s=e.i(85278),l=e.i(3781),u=r([i,n,o,a,s]);async function d(e,r){try{let r=e.headers.authorization;if(!r||!r.startsWith("Bearer "))throw new s.AppError("Authentication required",401,s.ErrorCodes.UNAUTHORIZED);let t=r.substring(7),{userId:n}=await i.authService.verifyToken(t),o=await i.authService.getUserProfile(n);return e.user=o,e.userId=o.id,e.roleId=o.roleId,o}catch(r){throw l.logger.error("Authentication failed",{error:r instanceof Error?r.message:"Unknown error",path:e.url}),r}}async function c(e,r,t){try{e.user&&e.roleId||await d(e,r);let i=e.roleId,u=await n.db.select().from(o.rolePermissions).innerJoin(o.permissions,(0,a.eq)(o.permissions.id,o.rolePermissions.permissionId)).where((0,a.and)((0,a.eq)(o.rolePermissions.roleId,i),(0,a.eq)(o.permissions.name,t),(0,a.eq)(o.rolePermissions.isActive,!0),(0,a.eq)(o.rolePermissions.isDeleted,!1),(0,a.eq)(o.permissions.isActive,!0),(0,a.eq)(o.permissions.isDeleted,!1))).limit(1);if(0===u.length)throw new s.AppError(`Permission denied: ${t} required`,403,s.ErrorCodes.FORBIDDEN);l.logger.info("Permission check passed",{userId:e.userId,roleId:i,permission:t})}catch(r){throw l.logger.error("Permission check failed",{error:r instanceof Error?r.message:"Unknown error",userId:e.userId,permission:t,path:e.url}),r}}[i,n,o,a,s]=u.then?(await u)():u,e.s(["requireAuth",()=>d,"requirePermission",()=>c]),t()}catch(e){t(e)}},!1),99751,e=>e.a(async(r,t)=>{try{var i=e.i(13574),n=e.i(60901),o=e.i(85278),a=e.i(3781),s=r([i,n,o]);async function l(e,r){if("POST"!==e.method)return r.status(405).json({message:"Method not allowed"});try{await (0,n.requireAuth)(e,r),await (0,n.requirePermission)(e,r,"request_close");let t=e.userId,s=parseInt(e.query.id);if(isNaN(s))return(0,o.sendErrorResponse)(r,{message:"Invalid request ID",code:"VALIDATION_ERROR",statusCode:400});let l=await i.requestService.closeRequest(s,t);return a.logger.apiResponse(e.method,e.url,200,0,t,e.headers["x-request-id"]),(0,o.sendSuccessResponse)(r,l)}catch(i){let t=(0,o.handleApiError)(i);return a.logger.error("Close request API error",{error:t.message,code:t.code,requestId:e.headers["x-request-id"]}),(0,o.sendErrorResponse)(r,t)}}[i,n,o]=s.then?(await s)():s,e.s(["default",()=>l]),t()}catch(e){t(e)}},!1),50382,e=>e.a(async(r,t)=>{try{var i=e.i(89304),n=e.i(36438),o=e.i(90950),a=e.i(17885),s=e.i(99751),l=e.i(8911),u=e.i(95011),d=e.i(40430),c=r([s]);[s]=c.then?(await c)():c;let f=(0,a.hoist)(s,"default"),p=(0,a.hoist)(s,"config"),m=new o.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/admin/requests/[id]/close",pathname:"/api/admin/requests/[id]/close",bundlePath:"",filename:""},userland:s,distDir:".next",relativeProjectDir:""});async function g(e,r,t){m.isDev&&(0,d.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/admin/requests/[id]/close";n=n.replace(/\/index$/,"")||"/";let o=await m.prepare(e,r,{srcPage:n});if(!o){r.statusCode=400,r.end("Bad Request"),null==t.waitUntil||t.waitUntil.call(t,Promise.resolve());return}let{query:a,params:s,prerenderManifest:c,routerServerContext:g}=o;try{let t=e.method||"GET",i=(0,l.getTracer)(),o=i.getActiveScopeSpan(),d=m.instrumentationOnRequestError.bind(m),f=async o=>m.render(e,r,{query:{...a,...s},params:s,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:m.isDev,page:"/api/admin/requests/[id]/close",internalRevalidate:null==g?void 0:g.revalidate,onError:(...r)=>d(e,...r)}).finally(()=>{if(!o)return;o.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let e=i.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=e.get("next.route");if(a){let e=`${t} ${a}`;o.setAttributes({"next.route":a,"http.route":a,"next.span_name":e}),o.updateName(e)}else o.updateName(`${t} ${n}`)});o?await f(o):await i.withPropagatedContext(e.headers,()=>i.trace(u.BaseServerSpan.handleRequest,{spanName:`${t} ${n}`,kind:l.SpanKind.SERVER,attributes:{"http.method":t,"http.target":e.url}},f))}catch(e){if(m.isDev)throw e;(0,i.sendError)(r,500,"Internal Server Error")}finally{null==t.waitUntil||t.waitUntil.call(t,Promise.resolve())}}e.s(["config",0,p,"default",0,f,"handler",()=>g]),t()}catch(e){t(e)}},!1),69182,e=>{e.v(e=>Promise.resolve().then(()=>e(23268)))},88749,e=>{e.v(e=>Promise.resolve().then(()=>e(85278)))}];

//# sourceMappingURL=projects_ticketing-platform_4a6fe898._.js.map