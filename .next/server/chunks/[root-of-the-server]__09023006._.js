module.exports=[70406,(e,r,s)=>{r.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},97010,e=>e.a(async(r,s)=>{try{let r=await e.y("zod");e.n(r),s()}catch(e){s(e)}},!0),20270,(e,r,s)=>{r.exports=e.x("dotenv/config",()=>require("dotenv/config"))},21783,e=>e.a(async(r,s)=>{try{let r=await e.y("drizzle-orm/postgres-js");e.n(r),s()}catch(e){s(e)}},!0),55443,e=>e.a(async(r,s)=>{try{let r=await e.y("postgres");e.n(r),s()}catch(e){s(e)}},!0),88707,e=>e.a(async(r,s)=>{try{e.i(20270);var t=e.i(21783),o=e.i(55443),i=r([t,o]);[t,o]=i.then?(await i)():i;let n=process.env.DATABASE_URL;if(!n)throw Error("DATABASE_URL environment variable is not set");let a=(0,o.default)(n,{prepare:!1,max:10,idle_timeout:20,connect_timeout:30,max_lifetime:1800,connection:{application_name:"ticketing-system"},onnotice:()=>{},debug:void 0}),d=(0,t.drizzle)(a);"undefined"!=typeof process&&(process.on("SIGTERM",async()=>{console.log("SIGTERM received, closing database connections..."),await a.end({timeout:5})}),process.on("SIGINT",async()=>{console.log("SIGINT received, closing database connections..."),await a.end({timeout:5})})),e.s(["db",0,d]),s()}catch(e){s(e)}},!1),3781,e=>{"use strict";class r{isDevelopment=!1;logLevel=process.env.LOG_LEVEL||"info";shouldLog(e){let r={debug:0,info:1,warn:2,error:3};return r[e]>=r[this.logLevel]}formatLog(e){let{level:r,message:s,timestamp:t,context:o,userId:i,requestId:n}=e,a=`[${t}] [${r.toUpperCase()}]`;return i&&(a+=` [USER:${i}]`),n&&(a+=` [REQ:${n}]`),a+=` ${s}`,o&&Object.keys(o).length>0&&(a+=` | Context: ${JSON.stringify(o)}`),a}log(e,r,s,t,o){if(!this.shouldLog(e))return;let i={level:e,message:r,timestamp:new Date().toISOString(),context:s,userId:t,requestId:o},n=this.formatLog(i);this.isDevelopment?console.log(`${{debug:"\x1b[36m",info:"\x1b[32m",warn:"\x1b[33m",error:"\x1b[31m"}[e]}${n}\x1b[0m`):console.log(JSON.stringify(i))}debug(e,r,s,t){this.log("debug",e,r,s,t)}info(e,r,s,t){this.log("info",e,r,s,t)}warn(e,r,s,t){this.log("warn",e,r,s,t)}error(e,r,s,t){this.log("error",e,r,s,t)}apiRequest(e,r,s,t,o){this.info(`API Request: ${e} ${r}`,{method:e,url:r,...s},t,o)}apiResponse(e,r,s,t,o,i){this.info(`API Response: ${e} ${r} - ${s} (${t}ms)`,{method:e,url:r,statusCode:s,duration:t},o,i)}databaseQuery(e,r,s,t){this.debug(`Database Query: ${e} (${r}ms)`,{query:e,duration:r},s,t)}authEvent(e,r,s,t){this.info(`Auth Event: ${e}`,{event:e,...s},r,t)}businessEvent(e,r,s,t,o,i){this.info(`Business Event: ${e}`,{event:e,entityType:r,entityId:s,...o},t,i)}errorEvent(e,r,s,t){this.error(`Error Event: ${e.message}`,{error:e.message,stack:e.stack,...r},s,t)}}let s=new r;e.s(["default",0,s,"logger",0,s])},85278,e=>e.a(async(r,s)=>{try{var t=e.i(97010),o=r([t]);[t]=o.then?(await o)():o;class d extends Error{statusCode;code;details;constructor(e,r=500,s,t){super(e),this.statusCode=r,this.code=s,this.details=t,this.name="AppError"}}function i(e){if(e instanceof d)return{message:e.message,code:e.code,statusCode:e.statusCode,details:e.details};if(e instanceof t.ZodError){let r=e.issues.map(e=>({field:e.path.join("."),message:e.message,code:e.code}));return{message:`Validation error: ${r.map(e=>`${e.field}: ${e.message}`).join(", ")}`,code:"VALIDATION_ERROR",statusCode:400,details:r.reduce((e,r)=>(e[r.field]=r.message,e),{})}}return e instanceof Error?{message:e.message,statusCode:500}:{message:"Internal server error",statusCode:500}}function n(e,r){let{statusCode:s,message:t,code:o,details:i={}}=r;e.status(s).json({success:!1,error:{message:t,code:o,details:i},timestamp:new Date().toISOString()})}function a(e,r,s=200){e.status(s).json({success:!0,data:r,timestamp:new Date().toISOString()})}e.s(["AppError",()=>d,"ErrorCodes",0,{VALIDATION_ERROR:"VALIDATION_ERROR",AUTHENTICATION_ERROR:"AUTHENTICATION_ERROR",AUTHORIZATION_ERROR:"AUTHORIZATION_ERROR",UNAUTHORIZED:"UNAUTHORIZED",FORBIDDEN:"FORBIDDEN",NOT_FOUND:"NOT_FOUND",DUPLICATE_ENTRY:"DUPLICATE_ENTRY",INVALID_CREDENTIALS:"INVALID_CREDENTIALS",TOKEN_EXPIRED:"TOKEN_EXPIRED",TOKEN_INVALID:"TOKEN_INVALID",USER_NOT_FOUND:"USER_NOT_FOUND",PARTNER_NOT_FOUND:"PARTNER_NOT_FOUND",REQUEST_NOT_FOUND:"REQUEST_NOT_FOUND",BRANCH_NOT_FOUND:"BRANCH_NOT_FOUND",CATEGORY_NOT_FOUND:"CATEGORY_NOT_FOUND",SERVICE_NOT_FOUND:"SERVICE_NOT_FOUND",INVALID_STATUS_TRANSITION:"INVALID_STATUS_TRANSITION",SLA_TIMEOUT:"SLA_TIMEOUT",CONFIGURATION_NOT_FOUND:"CONFIGURATION_NOT_FOUND"},"handleApiError",()=>i,"sendErrorResponse",()=>n,"sendSuccessResponse",()=>a]),s()}catch(e){s(e)}},!1),29229,e=>e.a(async(r,s)=>{try{let r=await e.y("bcryptjs");e.n(r),s()}catch(e){s(e)}},!0),96187,(e,r,s)=>{r.exports=e.x("jsonwebtoken",()=>require("jsonwebtoken"))},11797,e=>e.a(async(r,s)=>{try{var t=e.i(29229),o=e.i(96187),i=e.i(88707),n=e.i(78156),a=e.i(89722),d=e.i(85278),l=e.i(3781),u=r([t,i,n,a,d]);[t,i,n,a,d]=u.then?(await u)():u;let c=process.env.JWT_SECRET,g=process.env.JWT_REFRESH_SECRET,p=process.env.JWT_EXPIRES_IN||"15m",f=process.env.JWT_REFRESH_EXPIRES_IN||"7d",w=new class{async register(e){try{if(l.logger.info("Starting user registration",{email:e.email}),(await i.db.select().from(n.users).where((0,a.eq)(n.users.email,e.email)).limit(1)).length>0)throw new d.AppError("User with this email already exists",400,d.ErrorCodes.DUPLICATE_ENTRY);let r=await t.default.hash(e.password,12),s=await i.db.insert(n.users).values({name:e.name,email:e.email,phone:e.phone,password:r,roleId:4,userType:e.userType,languagePreference:e.languagePreference,emailVerifiedAt:new Date}).returning();await i.db.insert(n.customers).values({userId:s[0].id,phone:e.phone,preferredLanguage:e.languagePreference});let o=await this.generateTokens(s[0].id);await i.db.update(n.users).set({lastLoginAt:new Date}).where((0,a.eq)(n.users.id,s[0].id));let u={id:s[0].id,name:s[0].name,email:s[0].email,phone:s[0].phone||void 0,userType:s[0].userType,roleId:s[0].roleId,partnerId:s[0].partnerId||void 0,languagePreference:s[0].languagePreference||void 0,emailVerifiedAt:s[0].emailVerifiedAt||void 0,phoneVerifiedAt:s[0].phoneVerifiedAt||void 0,lastLoginAt:s[0].lastLoginAt||void 0,createdAt:s[0].createdAt};return l.logger.info("User registered successfully",{userId:s[0].id,email:e.email}),{user:u,tokens:o}}catch(r){throw l.logger.error("Registration failed",{error:r instanceof Error?r.message:"Unknown error",email:e.email}),r}}async login(e,r,s){try{l.logger.info("Starting user login",{email:e.email});let o=await i.db.select().from(n.users).where((0,a.and)((0,a.eq)(n.users.email,e.email),(0,a.eq)(n.users.isActive,!0),(0,a.eq)(n.users.isDeleted,!1))).limit(1);if(0===o.length||!await t.default.compare(e.password,o[0].password))throw new d.AppError("Invalid credentials",401,d.ErrorCodes.INVALID_CREDENTIALS);let u=await this.generateTokens(o[0].id,r,s);await i.db.update(n.users).set({lastLoginAt:new Date}).where((0,a.eq)(n.users.id,o[0].id));let c={id:o[0].id,name:o[0].name,email:o[0].email,phone:o[0].phone||void 0,userType:o[0].userType,roleId:o[0].roleId,partnerId:o[0].partnerId||void 0,languagePreference:o[0].languagePreference||void 0,emailVerifiedAt:o[0].emailVerifiedAt||void 0,phoneVerifiedAt:o[0].phoneVerifiedAt||void 0,lastLoginAt:o[0].lastLoginAt||void 0,createdAt:o[0].createdAt};return l.logger.info("User logged in successfully",{userId:o[0].id,email:e.email}),{user:c,tokens:u}}catch(r){throw l.logger.error("Login failed",{error:r instanceof Error?r.message:"Unknown error",email:e.email}),r}}async refreshToken(e){try{l.logger.info("Refreshing token");let r=o.default.verify(e,g),s=await i.db.select().from(n.userSessions).where((0,a.and)((0,a.eq)(n.userSessions.sessionId,r.sessionId),(0,a.eq)(n.userSessions.isActive,!0))).limit(1);if(0===s.length)throw new d.AppError("Invalid refresh token",401,d.ErrorCodes.TOKEN_INVALID);if(s[0].expiresAt<new Date)throw new d.AppError("Refresh token expired",401,d.ErrorCodes.TOKEN_EXPIRED);let t=await this.generateTokensForSession(r.userId,r.sessionId,s[0].deviceInfo||void 0,s[0].ipAddress||void 0);return l.logger.info("Token refreshed successfully",{userId:r.userId}),{tokens:t}}catch(e){throw l.logger.error("Token refresh failed",{error:e instanceof Error?e.message:"Unknown error"}),e}}async logout(e){try{l.logger.info("Logging out user");let r=o.default.decode(e);r&&r.sessionId&&(await i.db.update(n.userSessions).set({isActive:!1}).where((0,a.eq)(n.userSessions.sessionId,r.sessionId)),l.logger.info("User logged out successfully",{sessionId:r.sessionId}))}catch(e){throw l.logger.error("Logout failed",{error:e instanceof Error?e.message:"Unknown error"}),e}}async getUserProfile(e){try{let r=await i.db.select().from(n.users).where((0,a.and)((0,a.eq)(n.users.id,e),(0,a.eq)(n.users.isActive,!0),(0,a.eq)(n.users.isDeleted,!1))).limit(1);if(0===r.length)throw new d.AppError("User not found",404,d.ErrorCodes.USER_NOT_FOUND);return{id:r[0].id,name:r[0].name,email:r[0].email,phone:r[0].phone||void 0,userType:r[0].userType,roleId:r[0].roleId,partnerId:r[0].partnerId||void 0,languagePreference:r[0].languagePreference||void 0,emailVerifiedAt:r[0].emailVerifiedAt||void 0,phoneVerifiedAt:r[0].phoneVerifiedAt||void 0,lastLoginAt:r[0].lastLoginAt||void 0,createdAt:r[0].createdAt}}catch(r){throw l.logger.error("Get user profile failed",{error:r instanceof Error?r.message:"Unknown error",userId:e}),r}}async changePassword(e,r){try{l.logger.info("Changing user password",{userId:e});let s=await i.db.select().from(n.users).where((0,a.and)((0,a.eq)(n.users.id,e),(0,a.eq)(n.users.isActive,!0),(0,a.eq)(n.users.isDeleted,!1))).limit(1);if(0===s.length)throw new d.AppError("User not found",404,d.ErrorCodes.USER_NOT_FOUND);if(!await t.default.compare(r.currentPassword,s[0].password))throw new d.AppError("Current password is incorrect",400,d.ErrorCodes.INVALID_CREDENTIALS);let o=await t.default.hash(r.newPassword,12);await i.db.update(n.users).set({password:o,updatedAt:new Date}).where((0,a.eq)(n.users.id,e)),l.logger.info("Password changed successfully",{userId:e})}catch(r){throw l.logger.error("Change password failed",{error:r instanceof Error?r.message:"Unknown error",userId:e}),r}}async updateProfile(e,r){try{l.logger.info("Updating user profile",{userId:e});let s=await i.db.update(n.users).set({...r,updatedAt:new Date}).where((0,a.and)((0,a.eq)(n.users.id,e),(0,a.eq)(n.users.isActive,!0),(0,a.eq)(n.users.isDeleted,!1))).returning();if(0===s.length)throw new d.AppError("User not found",404,d.ErrorCodes.USER_NOT_FOUND);r.phone&&"customer"===s[0].userType&&await i.db.update(n.customers).set({phone:r.phone,preferredLanguage:r.languagePreference||s[0].languagePreference,updatedAt:new Date}).where((0,a.eq)(n.customers.userId,e));let t={id:s[0].id,name:s[0].name,email:s[0].email,phone:s[0].phone||void 0,userType:s[0].userType,roleId:s[0].roleId,partnerId:s[0].partnerId||void 0,languagePreference:s[0].languagePreference||void 0,emailVerifiedAt:s[0].emailVerifiedAt||void 0,phoneVerifiedAt:s[0].phoneVerifiedAt||void 0,lastLoginAt:s[0].lastLoginAt||void 0,createdAt:s[0].createdAt};return l.logger.info("Profile updated successfully",{userId:e}),t}catch(r){throw l.logger.error("Update profile failed",{error:r instanceof Error?r.message:"Unknown error",userId:e}),r}}async generateTokens(e,r,s){let t=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return this.generateTokensForSession(e,t,r,s)}async generateTokensForSession(e,r,s,t){let u=o.default.sign({userId:e,sessionId:r},c,{expiresIn:p}),w=o.default.sign({userId:e,sessionId:r},g,{expiresIn:f}),E=this.getTokenExpirationTime(p);try{let o=await i.db.select().from(n.userSessions).where((0,a.eq)(n.userSessions.sessionId,r)).limit(1);0===o.length?(await i.db.insert(n.userSessions).values({userId:e,sessionId:r,expiresAt:new Date(Date.now()+1e3*this.getTokenExpirationTime(f)),deviceInfo:s,ipAddress:t}),l.logger.info("Session created successfully",{userId:e,sessionId:r})):(await i.db.update(n.userSessions).set({expiresAt:new Date(Date.now()+1e3*this.getTokenExpirationTime(f)),isActive:!0}).where((0,a.eq)(n.userSessions.sessionId,r)),l.logger.info("Session refreshed successfully",{userId:e,sessionId:r}))}catch(r){throw l.logger.error("Failed to create/update session",{error:r instanceof Error?r.message:"Unknown error",userId:e}),new d.AppError("Failed to create session",500,"DATABASE_ERROR")}return{accessToken:u,refreshToken:w,expiresIn:E}}getTokenExpirationTime(e){let r=e.slice(-1),s=parseInt(e.slice(0,-1));switch(r){case"s":return s;case"m":return 60*s;case"h":return 60*s*60;case"d":return 24*s*3600;default:return 900}}async verifyToken(e){try{let r=o.default.verify(e,c),s=await i.db.select().from(n.userSessions).where((0,a.and)((0,a.eq)(n.userSessions.sessionId,r.sessionId),(0,a.eq)(n.userSessions.isActive,!0))).limit(1);if(0===s.length)throw new d.AppError("Session expired or invalid",401,d.ErrorCodes.TOKEN_INVALID);if(s[0].expiresAt&&s[0].expiresAt<new Date)throw await i.db.update(n.userSessions).set({isActive:!1}).where((0,a.eq)(n.userSessions.id,s[0].id)),new d.AppError("Session expired",401,d.ErrorCodes.TOKEN_EXPIRED);return r}catch(e){if(e instanceof o.default.JsonWebTokenError)throw new d.AppError("Invalid token",401,d.ErrorCodes.TOKEN_INVALID);if(e instanceof o.default.TokenExpiredError)throw new d.AppError("Token expired",401,d.ErrorCodes.TOKEN_EXPIRED);throw e}}async generatePasswordResetToken(e){try{l.logger.info("Generating password reset token",{email:e});let r=await i.db.select().from(n.users).where((0,a.and)((0,a.eq)(n.users.email,e),(0,a.eq)(n.users.isActive,!0),(0,a.eq)(n.users.isDeleted,!1))).limit(1),s="";return r.length>0?(s=o.default.sign({userId:r[0].id,email:r[0].email,type:"password_reset"},c,{expiresIn:"1h"}),l.logger.info("Password reset token generated",{email:e,userId:r[0].id})):l.logger.info("Password reset requested for non-existent email",{email:e}),s}catch(r){throw l.logger.error("Generate password reset token failed",{error:r instanceof Error?r.message:"Unknown error",email:e}),r}}async verifyPasswordResetToken(e){try{let r=o.default.verify(e,c);if("password_reset"!==r.type)throw new d.AppError("Invalid reset token",400,d.ErrorCodes.TOKEN_INVALID);let s=await i.db.select().from(n.users).where((0,a.and)((0,a.eq)(n.users.id,r.userId),(0,a.eq)(n.users.isActive,!0),(0,a.eq)(n.users.isDeleted,!1))).limit(1);if(0===s.length)throw new d.AppError("User not found or inactive",404,d.ErrorCodes.USER_NOT_FOUND);return{userId:r.userId,email:r.email}}catch(e){if(e instanceof o.default.TokenExpiredError)throw new d.AppError("Reset token has expired",400,d.ErrorCodes.TOKEN_EXPIRED);if(e instanceof o.default.JsonWebTokenError)throw new d.AppError("Invalid reset token",400,d.ErrorCodes.TOKEN_INVALID);throw e}}async resetPassword(e,r){try{l.logger.info("Resetting password");let{userId:s}=await this.verifyPasswordResetToken(e),o=await t.default.hash(r,12);await i.db.update(n.users).set({password:o,updatedAt:new Date}).where((0,a.eq)(n.users.id,s)),await i.db.update(n.userSessions).set({isActive:!1}).where((0,a.eq)(n.userSessions.userId,s)),l.logger.info("Password reset successfully",{userId:s})}catch(e){throw l.logger.error("Reset password failed",{error:e instanceof Error?e.message:"Unknown error"}),e}}};e.s(["authService",0,w]),s()}catch(e){s(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__09023006._.js.map