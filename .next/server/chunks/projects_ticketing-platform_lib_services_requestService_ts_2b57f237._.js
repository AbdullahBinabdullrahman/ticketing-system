module.exports=[13574,e=>e.a(async(t,r)=>{try{var s=e.i(88707),a=e.i(78156),i=e.i(89722),n=e.i(85278),o=e.i(3781),u=e.i(48841),c=e.i(23268),d=t([s,a,i,n,c]);[s,a,i,n,c]=d.then?(await d)():d;let m=new class{async createRequest(e,t){try{o.logger.info("Creating new request",{customerId:t});let r=await this.generateRequestNumber(),u=await s.db.select().from(a.categories).where((0,i.eq)(a.categories.id,e.categoryId)).limit(1);if(0===u.length)throw new n.AppError("Category not found",404,n.ErrorCodes.CATEGORY_NOT_FOUND);let c=null;e.serviceId&&(c=(await s.db.select().from(a.services).where((0,i.eq)(a.services.id,e.serviceId)).limit(1))[0]||null);let d=await s.db.select().from(a.pickupOptionTypes).where((0,i.eq)(a.pickupOptionTypes.id,e.pickupOptionId)).limit(1);if(0===d.length)throw new n.AppError("Pickup option not found",404,n.ErrorCodes.SERVICE_NOT_FOUND);let m=await s.db.insert(a.requests).values({requestNumber:r,customerId:t,customerName:e.customerName,customerPhone:e.customerPhone,customerLat:e.customerLat.toString(),customerLng:e.customerLng.toString(),customerAddress:e.customerAddress,categoryId:e.categoryId,serviceId:e.serviceId,pickupOptionId:e.pickupOptionId,status:"submitted",submittedAt:new Date,createdById:t}).returning();await this.logStatusChange(m[0].id,"submitted",t,"Request submitted"),await this.notifyAdmins("request_submitted","New Request Submitted",`New request ${r} has been submitted`,m[0].id),await this.sendNewRequestEmail(m[0].id);let l={id:m[0].id,requestNumber:m[0].requestNumber,customerId:m[0].customerId,customerName:m[0].customerName,customerPhone:m[0].customerPhone,customerLat:parseFloat(m[0].customerLat),customerLng:parseFloat(m[0].customerLng),customerAddress:m[0].customerAddress,categoryId:m[0].categoryId,categoryName:u[0].name,categoryNameAr:u[0].nameAr||"",serviceId:m[0].serviceId||void 0,serviceName:c?.name,serviceNameAr:c?.nameAr||void 0,pickupOptionId:m[0].pickupOptionId,pickupOptionName:d[0].name,pickupOptionNameAr:d[0].nameAr||"",status:m[0].status||"submitted",slaDeadline:m[0].slaDeadline||void 0,submittedAt:m[0].submittedAt,assignedAt:m[0].assignedAt||void 0,confirmedAt:m[0].confirmedAt||void 0,rejectedAt:m[0].rejectedAt||void 0,inProgressAt:m[0].inProgressAt||void 0,completedAt:m[0].completedAt||void 0,closedAt:m[0].closedAt||void 0,rating:m[0].rating||void 0,feedback:m[0].feedback||void 0,createdAt:m[0].createdAt,updatedAt:m[0].updatedAt};return o.logger.info("Request created successfully",{requestId:m[0].id,requestNumber:r}),l}catch(e){throw o.logger.error("Create request failed",{error:e instanceof Error?e.message:"Unknown error",customerId:t}),e}}async assignRequest(e,t,r){try{o.logger.info("Assigning request",{requestId:e,partnerId:t.partnerId,branchId:t.branchId});let u=await s.db.select().from(a.requests).where((0,i.eq)(a.requests.id,e)).limit(1);if(0===u.length)throw new n.AppError("Request not found",404,n.ErrorCodes.REQUEST_NOT_FOUND);if(["completed","closed"].includes(u[0].status||""))throw new n.AppError("Cannot reassign completed or closed requests",400,n.ErrorCodes.INVALID_STATUS_TRANSITION);let c=null!==u[0].partnerId,d=await s.db.select().from(a.partners).where((0,i.eq)(a.partners.id,t.partnerId)).limit(1);if(0===d.length)throw new n.AppError("Partner not found",404,n.ErrorCodes.PARTNER_NOT_FOUND);let m=await s.db.select().from(a.branches).where((0,i.and)((0,i.eq)(a.branches.id,t.branchId),(0,i.eq)(a.branches.partnerId,t.partnerId))).limit(1);if(0===m.length)throw new n.AppError("Branch not found",404,n.ErrorCodes.BRANCH_NOT_FOUND);let l=await this.getSlaTimeout(t.partnerId),g=new Date(Date.now()+60*l*1e3),p=await s.db.update(a.requests).set({partnerId:t.partnerId,branchId:t.branchId,assignedByUserId:r,assignedAt:new Date,status:"assigned",slaDeadline:g,updatedAt:new Date}).where((0,i.eq)(a.requests.id,e)).returning();console.log("updatedRequest",p),c&&await s.db.update(a.requestAssignments).set({isActive:!1}).where((0,i.and)((0,i.eq)(a.requestAssignments.requestId,e),(0,i.eq)(a.requestAssignments.isActive,!0))),await s.db.insert(a.requestAssignments).values({requestId:e,partnerId:t.partnerId,branchId:t.branchId,assignedByUserId:r,assignedAt:new Date,response:"pending",isActive:!0});let q=c?`Reassigned to ${d[0].name} - ${m[0].name}`:`Assigned to ${d[0].name} - ${m[0].name}`;await this.logStatusChange(e,"assigned",r,q);let h=c?`Your request has been reassigned to ${d[0].name}`:`Your request has been assigned to ${d[0].name}`;await this.notifyUser(u[0].customerId,"request_assigned",c?"Request Reassigned":"Request Assigned",h,e),await this.notifyPartnerBranchUsers(t.branchId,"request_assigned",c?"Request Reassigned":"New Request Assigned",c?"Request reassigned to your branch":"New request assigned to your branch",e),await this.sendAssignmentEmail(e,d[0],m[0]);let f=await this.getRequestWithDetails(e);return o.logger.info("Request assigned successfully",{requestId:e,partnerId:t.partnerId,branchId:t.branchId}),f}catch(t){throw o.logger.error("Assign request failed",{error:t instanceof Error?t.message:"Unknown error",requestId:e}),t}}async updateRequestStatus(e,t,r){try{o.logger.info("Updating request status",{requestId:e,status:t.status,userId:r});let u=await s.db.select().from(a.requests).where((0,i.eq)(a.requests.id,e)).limit(1);if(0===u.length)throw new n.AppError("Request not found",404,n.ErrorCodes.REQUEST_NOT_FOUND);if(!this.getValidStatusTransitions(u[0].status||"unassigned").includes(t.status))throw new n.AppError(`Invalid status transition from ${u[0].status} to ${t.status}`,400,n.ErrorCodes.INVALID_STATUS_TRANSITION);if("rejected"===t.status&&!t.rejectionReason)throw new n.AppError("Rejection reason is required when rejecting a request",400,n.ErrorCodes.VALIDATION_ERROR);let c={status:t.status,updatedAt:new Date,updatedById:r};switch(t.status){case"confirmed":c.confirmedAt=new Date;break;case"rejected":c.rejectedAt=new Date,c.status="unassigned";break;case"in_progress":c.inProgressAt=new Date;break;case"completed":c.completedAt=new Date}await s.db.update(a.requests).set(c).where((0,i.eq)(a.requests.id,e)).returning(),o.logger.info("Request status updated in database",{requestId:e,newStatus:t.status}),("confirmed"===t.status||"rejected"===t.status)&&(await s.db.update(a.requestAssignments).set({respondedAt:new Date,response:"confirmed"===t.status?"confirmed":"rejected",rejectionReason:t.rejectionReason}).where((0,i.and)((0,i.eq)(a.requestAssignments.requestId,e),i.sql`${a.requestAssignments.response} = 'pending'::assignment_response_enum`)),o.logger.info("Assignment record updated",{requestId:e,response:"confirmed"===t.status?"confirmed":"rejected"})),await this.logStatusChange(e,t.status,r,t.notes),o.logger.info("Status change logged in timeline",{requestId:e,status:t.status}),"confirmed"===t.status?(await this.notifyUser(u[0].customerId,"request_confirmed","Request Confirmed","Your request has been confirmed by the partner",e),await this.notifyAdmins("request_confirmed","Request Confirmed",`Request ${u[0].requestNumber} has been confirmed`,e),await this.sendRequestAcceptedEmail(e)):"rejected"===t.status?(await this.notifyUser(u[0].customerId,"request_rejected","Request Rejected","Your request has been rejected. We will find an alternative partner.",e),await this.notifyAdmins("request_rejected","Request Rejected - Needs Reassignment",`Request ${u[0].requestNumber} has been rejected and needs reassignment`,e),await this.sendRequestRejectedEmail(e,t.rejectionReason)):"in_progress"===t.status?(await this.notifyUser(u[0].customerId,"request_in_progress","Service In Progress","The partner has started working on your request",e),await this.sendStatusChangeEmail(e,"in_progress",t.notes)):"completed"===t.status&&(await this.notifyUser(u[0].customerId,"request_completed","Service Completed","Your service has been completed. Please rate your experience.",e),await this.notifyAdmins("request_completed","Request Completed - Verify with Customer",`Request ${u[0].requestNumber} has been completed and needs verification`,e),await this.sendStatusChangeEmail(e,"completed",t.notes));let d=await this.getRequestWithDetails(e);return o.logger.info("Request status updated successfully",{requestId:e,status:t.status,userId:r}),d}catch(t){throw o.logger.error("Update request status failed",{error:t instanceof Error?t.message:"Unknown error",requestId:e}),t}}async rateRequest(e,t,r){try{o.logger.info("Rating request",{requestId:e,rating:t.rating,customerId:r});let u=await s.db.select().from(a.requests).where((0,i.and)((0,i.eq)(a.requests.id,e),(0,i.eq)(a.requests.customerId,r))).limit(1);if(0===u.length)throw new n.AppError("Request not found",404,n.ErrorCodes.REQUEST_NOT_FOUND);if("completed"!==u[0].status)throw new n.AppError("Request must be completed before rating",400,n.ErrorCodes.INVALID_STATUS_TRANSITION);await s.db.update(a.requests).set({rating:t.rating,feedback:t.feedback,ratedAt:new Date,updatedAt:new Date,updatedById:r}).where((0,i.eq)(a.requests.id,e)).returning(),await this.logStatusChange(e,"rated",r,`Rated ${t.rating} stars`);let c=await this.getRequestWithDetails(e);return o.logger.info("Request rated successfully",{requestId:e,rating:t.rating,customerId:r}),c}catch(t){throw o.logger.error("Rate request failed",{error:t instanceof Error?t.message:"Unknown error",requestId:e}),t}}async closeRequest(e,t){try{o.logger.info("Closing request",{requestId:e,closedByUserId:t});let r=await s.db.select().from(a.requests).where((0,i.eq)(a.requests.id,e)).limit(1);if(0===r.length)throw new n.AppError("Request not found",404,n.ErrorCodes.REQUEST_NOT_FOUND);if("completed"!==r[0].status)throw new n.AppError("Request must be completed before closing",400,n.ErrorCodes.INVALID_STATUS_TRANSITION);await s.db.update(a.requests).set({status:"closed",closedAt:new Date,closedByUserId:t,updatedAt:new Date,updatedById:t}).where((0,i.eq)(a.requests.id,e)).returning(),await this.logStatusChange(e,"closed",t,"Request closed after customer verification"),await this.notifyUser(r[0].customerId,"request_closed","Request Closed","Your request has been closed. Thank you for using our service!",e),r[0].partnerId&&await this.notifyPartnerBranchUsers(r[0].branchId,"request_closed","Request Closed",`Request ${r[0].requestNumber} has been closed successfully`,e);let u=await this.getRequestWithDetails(e);return o.logger.info("Request closed successfully",{requestId:e,closedByUserId:t}),u}catch(t){throw o.logger.error("Close request failed",{error:t instanceof Error?t.message:"Unknown error",requestId:e}),t}}async getRequests(e,t,r){try{o.logger.info("Getting requests",{filters:e,userId:t,userType:r});let n=[(0,i.eq)(a.requests.isActive,!0),(0,i.eq)(a.requests.isDeleted,!1)];if("customer"===r&&t)n.push((0,i.eq)(a.requests.customerId,t));else if("partner"===r&&t){let e=await s.db.select({partnerId:a.users.partnerId}).from(a.users).where((0,i.eq)(a.users.id,t)).limit(1);e.length>0&&e[0].partnerId&&n.push((0,i.eq)(a.requests.partnerId,e[0].partnerId))}e.status&&n.push((0,i.eq)(a.requests.status,e.status)),e.categoryId&&n.push((0,i.eq)(a.requests.categoryId,e.categoryId)),e.partnerId&&n.push((0,i.eq)(a.requests.partnerId,e.partnerId)),e.branchId&&n.push((0,i.eq)(a.requests.branchId,e.branchId)),e.dateFrom&&n.push((0,i.gte)(a.requests.submittedAt,new Date(e.dateFrom))),e.dateTo&&n.push((0,i.lte)(a.requests.submittedAt,new Date(e.dateTo)));let u=await s.db.select({count:(0,i.count)()}).from(a.requests).where((0,i.and)(...n)),c=u[0]?.count||0,d=(await s.db.select({id:a.requests.id,requestNumber:a.requests.requestNumber,customerId:a.requests.customerId,customerName:a.requests.customerName,customerPhone:a.requests.customerPhone,customerLat:a.requests.customerLat,customerLng:a.requests.customerLng,customerAddress:a.requests.customerAddress,categoryId:a.requests.categoryId,categoryName:a.categories.name,categoryNameAr:a.categories.nameAr,serviceId:a.requests.serviceId,serviceName:a.services.name,serviceNameAr:a.services.nameAr,pickupOptionId:a.requests.pickupOptionId,pickupOptionName:a.pickupOptionTypes.name,pickupOptionNameAr:a.pickupOptionTypes.nameAr,partnerId:a.requests.partnerId,partnerName:a.partners.name,branchId:a.requests.branchId,branchName:a.branches.name,status:a.requests.status,slaDeadline:a.requests.slaDeadline,submittedAt:a.requests.submittedAt,assignedAt:a.requests.assignedAt,confirmedAt:a.requests.confirmedAt,rejectedAt:a.requests.rejectedAt,inProgressAt:a.requests.inProgressAt,completedAt:a.requests.completedAt,closedAt:a.requests.closedAt,rating:a.requests.rating,feedback:a.requests.feedback,createdAt:a.requests.createdAt,updatedAt:a.requests.updatedAt}).from(a.requests).leftJoin(a.categories,(0,i.eq)(a.requests.categoryId,a.categories.id)).leftJoin(a.services,(0,i.eq)(a.requests.serviceId,a.services.id)).leftJoin(a.pickupOptionTypes,(0,i.eq)(a.requests.pickupOptionId,a.pickupOptionTypes.id)).leftJoin(a.partners,(0,i.eq)(a.requests.partnerId,a.partners.id)).leftJoin(a.branches,(0,i.eq)(a.requests.branchId,a.branches.id)).where((0,i.and)(...n)).orderBy("asc"===e.sortOrder?(0,i.asc)(a.requests[e.sortBy]):(0,i.desc)(a.requests[e.sortBy])).limit(e.limit).offset((e.page-1)*e.limit)).map(e=>({id:e.id,requestNumber:e.requestNumber,customerId:e.customerId,customerName:e.customerName,customerPhone:e.customerPhone,customerLat:parseFloat(e.customerLat),customerLng:parseFloat(e.customerLng),customerAddress:e.customerAddress,categoryId:e.categoryId,categoryName:e.categoryName||"",categoryNameAr:e.categoryNameAr||"",serviceId:e.serviceId||void 0,serviceName:e.serviceName||void 0,serviceNameAr:e.serviceNameAr||void 0,pickupOptionId:e.pickupOptionId,pickupOptionName:e.pickupOptionName||"",pickupOptionNameAr:e.pickupOptionNameAr||"",partnerId:e.partnerId||void 0,partnerName:e.partnerName||void 0,branchId:e.branchId||void 0,branchName:e.branchName||void 0,status:e.status||"submitted",slaDeadline:e.slaDeadline||void 0,submittedAt:e.submittedAt,assignedAt:e.assignedAt||void 0,confirmedAt:e.confirmedAt||void 0,rejectedAt:e.rejectedAt||void 0,inProgressAt:e.inProgressAt||void 0,completedAt:e.completedAt||void 0,closedAt:e.closedAt||void 0,rating:e.rating||void 0,feedback:e.feedback||void 0,createdAt:e.createdAt,updatedAt:e.updatedAt}));return o.logger.info("Requests retrieved successfully",{count:d.length,total:c,filters:e}),{requests:d,total:c}}catch(t){throw o.logger.error("Get requests failed",{error:t instanceof Error?t.message:"Unknown error",filters:e}),t}}async getRequestWithDetails(e){try{let t=await s.db.select({id:a.requests.id,requestNumber:a.requests.requestNumber,customerId:a.requests.customerId,customerName:a.requests.customerName,customerPhone:a.requests.customerPhone,customerLat:a.requests.customerLat,customerLng:a.requests.customerLng,customerAddress:a.requests.customerAddress,categoryId:a.requests.categoryId,categoryName:a.categories.name,categoryNameAr:a.categories.nameAr,serviceId:a.requests.serviceId,serviceName:a.services.name,serviceNameAr:a.services.nameAr,pickupOptionId:a.requests.pickupOptionId,pickupOptionName:a.pickupOptionTypes.name,pickupOptionNameAr:a.pickupOptionTypes.nameAr,partnerId:a.requests.partnerId,partnerName:a.partners.name,branchId:a.requests.branchId,branchName:a.branches.name,status:a.requests.status,slaDeadline:a.requests.slaDeadline,submittedAt:a.requests.submittedAt,assignedAt:a.requests.assignedAt,confirmedAt:a.requests.confirmedAt,rejectedAt:a.requests.rejectedAt,inProgressAt:a.requests.inProgressAt,completedAt:a.requests.completedAt,closedAt:a.requests.closedAt,rating:a.requests.rating,feedback:a.requests.feedback,createdAt:a.requests.createdAt,updatedAt:a.requests.updatedAt}).from(a.requests).leftJoin(a.categories,(0,i.eq)(a.requests.categoryId,a.categories.id)).leftJoin(a.services,(0,i.eq)(a.requests.serviceId,a.services.id)).leftJoin(a.pickupOptionTypes,(0,i.eq)(a.requests.pickupOptionId,a.pickupOptionTypes.id)).leftJoin(a.partners,(0,i.eq)(a.requests.partnerId,a.partners.id)).leftJoin(a.branches,(0,i.eq)(a.requests.branchId,a.branches.id)).where((0,i.and)((0,i.eq)(a.requests.id,e),(0,i.eq)(a.requests.isActive,!0),(0,i.eq)(a.requests.isDeleted,!1))).limit(1);if(0===t.length)throw new n.AppError("Request not found",404,n.ErrorCodes.REQUEST_NOT_FOUND);let r=t[0];return{id:r.id,requestNumber:r.requestNumber,customerId:r.customerId,customerName:r.customerName,customerPhone:r.customerPhone,customerLat:parseFloat(r.customerLat),customerLng:parseFloat(r.customerLng),customerAddress:r.customerAddress,categoryId:r.categoryId,categoryName:r.categoryName||"",categoryNameAr:r.categoryNameAr||"",serviceId:r.serviceId||void 0,serviceName:r.serviceName||void 0,serviceNameAr:r.serviceNameAr||void 0,pickupOptionId:r.pickupOptionId,pickupOptionName:r.pickupOptionName||"",pickupOptionNameAr:r.pickupOptionNameAr||"",partnerId:r.partnerId||void 0,partnerName:r.partnerName||void 0,branchId:r.branchId||void 0,branchName:r.branchName||void 0,status:r.status||"unassigned",slaDeadline:r.slaDeadline||void 0,submittedAt:r.submittedAt,assignedAt:r.assignedAt||void 0,confirmedAt:r.confirmedAt||void 0,rejectedAt:r.rejectedAt||void 0,inProgressAt:r.inProgressAt||void 0,completedAt:r.completedAt||void 0,closedAt:r.closedAt||void 0,rating:r.rating||void 0,feedback:r.feedback||void 0,createdAt:r.createdAt,updatedAt:r.updatedAt}}catch(t){throw o.logger.error("Get request with details failed",{error:t instanceof Error?t.message:"Unknown error",requestId:e}),t}}async getRequestByNumber(e){try{let t=await s.db.select({id:a.requests.id,requestNumber:a.requests.requestNumber,customerId:a.requests.customerId,customerName:a.requests.customerName,customerPhone:a.requests.customerPhone,customerLat:a.requests.customerLat,customerLng:a.requests.customerLng,customerAddress:a.requests.customerAddress,categoryId:a.requests.categoryId,categoryName:a.categories.name,categoryNameAr:a.categories.nameAr,serviceId:a.requests.serviceId,serviceName:a.services.name,serviceNameAr:a.services.nameAr,pickupOptionId:a.requests.pickupOptionId,pickupOptionName:a.pickupOptionTypes.name,pickupOptionNameAr:a.pickupOptionTypes.nameAr,partnerId:a.requests.partnerId,partnerName:a.partners.name,branchId:a.requests.branchId,branchName:a.branches.name,status:a.requests.status,slaDeadline:a.requests.slaDeadline,submittedAt:a.requests.submittedAt,assignedAt:a.requests.assignedAt,confirmedAt:a.requests.confirmedAt,rejectedAt:a.requests.rejectedAt,inProgressAt:a.requests.inProgressAt,completedAt:a.requests.completedAt,closedAt:a.requests.closedAt,rating:a.requests.rating,feedback:a.requests.feedback,createdAt:a.requests.createdAt,updatedAt:a.requests.updatedAt}).from(a.requests).leftJoin(a.categories,(0,i.eq)(a.requests.categoryId,a.categories.id)).leftJoin(a.services,(0,i.eq)(a.requests.serviceId,a.services.id)).leftJoin(a.pickupOptionTypes,(0,i.eq)(a.requests.pickupOptionId,a.pickupOptionTypes.id)).leftJoin(a.partners,(0,i.eq)(a.requests.partnerId,a.partners.id)).leftJoin(a.branches,(0,i.eq)(a.requests.branchId,a.branches.id)).where((0,i.and)((0,i.eq)(a.requests.requestNumber,e),(0,i.eq)(a.requests.isActive,!0),(0,i.eq)(a.requests.isDeleted,!1))).limit(1);if(0===t.length)throw new n.AppError("Request not found",404,n.ErrorCodes.REQUEST_NOT_FOUND);let r=t[0];return{id:r.id,requestNumber:r.requestNumber,customerId:r.customerId,customerName:r.customerName,customerPhone:r.customerPhone,customerLat:parseFloat(r.customerLat),customerLng:parseFloat(r.customerLng),customerAddress:r.customerAddress,categoryId:r.categoryId,categoryName:r.categoryName||"",categoryNameAr:r.categoryNameAr||"",serviceId:r.serviceId||void 0,serviceName:r.serviceName||void 0,serviceNameAr:r.serviceNameAr||void 0,pickupOptionId:r.pickupOptionId,pickupOptionName:r.pickupOptionName||"",pickupOptionNameAr:r.pickupOptionNameAr||"",partnerId:r.partnerId||void 0,partnerName:r.partnerName||void 0,branchId:r.branchId||void 0,branchName:r.branchName||void 0,status:r.status||"unassigned",slaDeadline:r.slaDeadline||void 0,submittedAt:r.submittedAt,assignedAt:r.assignedAt||void 0,confirmedAt:r.confirmedAt||void 0,rejectedAt:r.rejectedAt||void 0,inProgressAt:r.inProgressAt||void 0,completedAt:r.completedAt||void 0,closedAt:r.closedAt||void 0,rating:r.rating||void 0,feedback:r.feedback||void 0,createdAt:r.createdAt,updatedAt:r.updatedAt}}catch(t){throw o.logger.error("Get request by number failed",{error:t instanceof Error?t.message:"Unknown error",requestNumber:e}),t}}async getRequestTimeline(e){try{return await s.db.select({id:a.requestStatusLog.id,status:a.requestStatusLog.status,changedByName:a.users.name,notes:a.requestStatusLog.notes,timestamp:a.requestStatusLog.timestamp}).from(a.requestStatusLog).leftJoin(a.users,(0,i.eq)(a.requestStatusLog.changedById,a.users.id)).where((0,i.eq)(a.requestStatusLog.requestId,e)).orderBy((0,i.asc)(a.requestStatusLog.timestamp))}catch(t){throw o.logger.error("Get request timeline failed",{error:t instanceof Error?t.message:"Unknown error",requestId:e}),t}}async getUnassignedRequests(){try{return(await this.getRequests({status:"unassigned",page:1,limit:100,sortBy:"createdAt",sortOrder:"desc"})).requests}catch(e){throw o.logger.error("Get unassigned requests failed",{error:e instanceof Error?e.message:"Unknown error"}),e}}async getRequestStats(){try{return{total:0,byStatus:{},byCategory:{},byPartner:{},slaBreaches:0,avgCompletionTime:0}}catch(e){throw o.logger.error("Get request stats failed",{error:e instanceof Error?e.message:"Unknown error"}),e}}async generateRequestNumber(){let e=new Date,t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),o=new Date(t,e.getMonth(),e.getDate()),u=new Date(t,e.getMonth(),e.getDate()+1),c=await s.db.select({count:i.sql`count(*)`}).from(a.requests).where((0,i.and)((0,i.gte)(a.requests.createdAt,o),(0,i.lte)(a.requests.createdAt,u))),d=(c[0]?.count||0)+1;return`REQ-${t}${r}${n}-${String(d).padStart(4,"0")}`}async getSlaTimeout(t){try{if(t){let e=await s.db.select().from(a.configurations).where((0,i.and)(i.sql`${a.configurations.scope} = 'partner'::config_scope_enum`,(0,i.eq)(a.configurations.partnerId,t),(0,i.eq)(a.configurations.key,"sla_timeout_minutes"),(0,i.eq)(a.configurations.isActive,!0),(0,i.eq)(a.configurations.isDeleted,!1))).limit(1);if(e.length>0){let t=parseInt(e[0].value,10);if(!isNaN(t)&&t>0)return t}}let{configurationService:r}=await e.A(69182);return await r.getSlaTimeout()}catch(e){return o.logger.error("Get SLA timeout failed",{error:e instanceof Error?e.message:"Unknown error",partnerId:t}),15}}getValidStatusTransitions(e){return({submitted:["assigned"],assigned:["confirmed","rejected"],confirmed:["in_progress"],in_progress:["completed","confirmed"],completed:["in_progress","closed"],rejected:["assigned"],unassigned:["assigned"],closed:[]})[e]||[]}async logStatusChange(e,t,r,i){await s.db.insert(a.requestStatusLog).values({requestId:e,status:t,changedById:r,notes:i})}async notifyUser(e,t,r,i,n){await s.db.insert(a.notifications).values({userId:e,type:t,title:r,body:i,requestId:n})}async notifyAdmins(e,t,r,n){for(let o of(await s.db.select({id:a.users.id}).from(a.users).where((0,i.and)(i.sql`${a.users.userType} = 'admin'::user_type_enum`,(0,i.eq)(a.users.isActive,!0),(0,i.eq)(a.users.isDeleted,!1)))))await this.notifyUser(o.id,e,t,r,n)}async notifyPartnerBranchUsers(e,t,r,n,o){for(let u of(await s.db.select({userId:a.branchUsers.userId}).from(a.branchUsers).where((0,i.and)((0,i.eq)(a.branchUsers.branchId,e),(0,i.eq)(a.branchUsers.isActive,!0),(0,i.eq)(a.branchUsers.isDeleted,!1)))))await this.notifyUser(u.userId,t,r,n,o)}async sendStatusChangeEmail(e,t,r){try{let n=await s.db.select({requestNumber:a.requests.requestNumber,customerName:a.users.name,customerEmail:a.users.email,customerLanguage:a.users.languagePreference,partnerName:a.partners.name,partnerEmail:a.partners.contactEmail,branchName:a.branches.name,branchAddress:a.branches.address,serviceName:a.services.name,categoryName:a.categories.name}).from(a.requests).leftJoin(a.customers,(0,i.eq)(a.requests.customerId,a.customers.id)).leftJoin(a.users,(0,i.eq)(a.customers.userId,a.users.id)).leftJoin(a.partners,(0,i.eq)(a.requests.partnerId,a.partners.id)).leftJoin(a.branches,(0,i.eq)(a.requests.branchId,a.branches.id)).leftJoin(a.services,(0,i.eq)(a.requests.serviceId,a.services.id)).leftJoin(a.categories,(0,i.eq)(a.services.categoryId,a.categories.id)).where((0,i.eq)(a.requests.id,e)).limit(1);if(0===n.length)return void o.logger.warn("Request not found for email notification",{requestId:e});let d=n[0];if(d.customerEmail){let s=(await c.configurationService.getSlaNotificationRecipients())[0]||"admin@system.com";await u.default.sendStatusChangeEmail({requestNumber:d.requestNumber||"",requestId:e,customerName:d.customerName||"",customerEmail:d.customerEmail,partnerName:d.partnerName||"",partnerEmail:d.partnerEmail||"",branchName:d.branchName||"",branchAddress:d.branchAddress||"",serviceName:d.serviceName||"",categoryName:d.categoryName||"",status:t,notes:r},t,s,d.customerLanguage||"en"),o.logger.info("Status change email sent to customer",{requestId:e,status:t,email:d.customerEmail})}if("in_progress"===t||"completed"===t){let s=await c.configurationService.getSlaNotificationRecipients();for(let a of s)await u.default.sendStatusChangeEmail({requestNumber:d.requestNumber||"",requestId:e,customerName:d.customerName||"",customerEmail:d.customerEmail||"",partnerName:d.partnerName||"",partnerEmail:d.partnerEmail||"",branchName:d.branchName||"",branchAddress:d.branchAddress||"",serviceName:d.serviceName||"",categoryName:d.categoryName||"",status:t,notes:r},t,a,d.customerLanguage||"en");o.logger.info("Status change email sent to admin team",{requestId:e,status:t,recipients:s.length})}}catch(r){o.logger.error("Failed to send status change email",{error:r,requestId:e,status:t})}}async sendAssignmentEmail(e,t,r){try{let n=await s.db.select({requestNumber:a.requests.requestNumber,customerName:a.requests.customerName,customerPhone:a.requests.customerPhone,customerAddress:a.requests.customerAddress,customerEmail:a.users.email,customerLanguage:a.users.languagePreference,serviceName:a.services.name,categoryName:a.categories.name}).from(a.requests).leftJoin(a.customers,(0,i.eq)(a.requests.customerId,a.customers.id)).leftJoin(a.users,(0,i.eq)(a.customers.userId,a.users.id)).leftJoin(a.services,(0,i.eq)(a.requests.serviceId,a.services.id)).leftJoin(a.categories,(0,i.eq)(a.requests.categoryId,a.categories.id)).where((0,i.eq)(a.requests.id,e)).limit(1);if(0===n.length)return void o.logger.warn("Request not found for assignment email",{requestId:e});let c=n[0],d=[];t.contactEmail&&d.push(t.contactEmail);let m=await s.db.select({email:a.users.email,languagePreference:a.users.languagePreference}).from(a.branchUsers).leftJoin(a.users,(0,i.eq)(a.branchUsers.userId,a.users.id)).where((0,i.and)((0,i.eq)(a.branchUsers.branchId,r.id),(0,i.eq)(a.branchUsers.isActive,!0),(0,i.eq)(a.branchUsers.isDeleted,!1)));for(let e of m)e.email&&!d.includes(e.email)&&d.push(e.email);if(0===d.length)return void o.logger.warn("No email recipients found for partner assignment",{requestId:e,partnerId:t.id,branchId:r.id});let l={requestNumber:c.requestNumber||"",requestId:e,customerName:c.customerName||"",customerEmail:c.customerEmail||"",partnerName:t.name,partnerEmail:d[0],branchName:r.name,branchAddress:r.address||"",serviceName:c.serviceName||"",categoryName:c.categoryName||"",status:"assigned"};for(let t of d)try{let r=m.find(e=>e.email===t)?.languagePreference||"en",s="ar"===r?"ar":"en",a=await u.default.sendRequestAssignedEmail({...l,partnerEmail:t},s);a.success||o.logger.error("Failed to send assignment email to recipient",{error:a.error,recipient:t,requestId:e})}catch(r){o.logger.error("Failed to send assignment email to recipient",{error:r,recipient:t,requestId:e})}o.logger.info("Assignment emails sent to partner",{requestId:e,partnerId:t.id,branchId:r.id,recipients:d.length})}catch(r){o.logger.error("Failed to send assignment emails",{error:r,requestId:e,partnerId:t.id})}}async sendRequestAcceptedEmail(e){try{let t=await s.db.select({requestNumber:a.requests.requestNumber,customerName:a.requests.customerName,customerEmail:a.users.email,customerLanguage:a.users.languagePreference,partnerName:a.partners.name,partnerEmail:a.partners.contactEmail,branchName:a.branches.name,branchAddress:a.branches.address,serviceName:a.services.name,categoryName:a.categories.name}).from(a.requests).leftJoin(a.customers,(0,i.eq)(a.requests.customerId,a.customers.id)).leftJoin(a.users,(0,i.eq)(a.customers.userId,a.users.id)).leftJoin(a.partners,(0,i.eq)(a.requests.partnerId,a.partners.id)).leftJoin(a.branches,(0,i.eq)(a.requests.branchId,a.branches.id)).leftJoin(a.services,(0,i.eq)(a.requests.serviceId,a.services.id)).leftJoin(a.categories,(0,i.eq)(a.requests.categoryId,a.categories.id)).where((0,i.eq)(a.requests.id,e)).limit(1);if(0===t.length)return void o.logger.warn("Request not found for acceptance email",{requestId:e});let r=t[0],n={requestNumber:r.requestNumber||"",requestId:e,customerName:r.customerName||"",customerEmail:r.customerEmail||"",partnerName:r.partnerName||"",partnerEmail:r.partnerEmail||"",branchName:r.branchName||"",branchAddress:r.branchAddress||"",serviceName:r.serviceName||"",categoryName:r.categoryName||"",status:"confirmed"},d=await c.configurationService.getSlaNotificationRecipients();for(let t of(0===d.length&&o.logger.warn("No admin emails configured for acceptance notifications"),d))try{let r=await u.default.sendRequestAcceptedEmail(n,t,"en");r.success||o.logger.error("Failed to send acceptance email to admin",{error:r.error,recipient:t,requestId:e})}catch(r){o.logger.error("Failed to send acceptance email to admin",{error:r,recipient:t,requestId:e})}o.logger.info("Request acceptance emails sent",{requestId:e,recipients:d.length})}catch(t){o.logger.error("Failed to send request acceptance emails",{error:t,requestId:e})}}async sendRequestRejectedEmail(e,t){try{let r=await s.db.select({requestNumber:a.requests.requestNumber,customerName:a.requests.customerName,customerEmail:a.users.email,partnerName:a.partners.name,partnerEmail:a.partners.contactEmail,branchName:a.branches.name,branchAddress:a.branches.address,serviceName:a.services.name,categoryName:a.categories.name}).from(a.requests).leftJoin(a.customers,(0,i.eq)(a.requests.customerId,a.customers.id)).leftJoin(a.users,(0,i.eq)(a.customers.userId,a.users.id)).leftJoin(a.partners,(0,i.eq)(a.requests.partnerId,a.partners.id)).leftJoin(a.branches,(0,i.eq)(a.requests.branchId,a.branches.id)).leftJoin(a.services,(0,i.eq)(a.requests.serviceId,a.services.id)).leftJoin(a.categories,(0,i.eq)(a.requests.categoryId,a.categories.id)).where((0,i.eq)(a.requests.id,e)).limit(1);if(0===r.length)return void o.logger.warn("Request not found for rejection email",{requestId:e});let n=r[0],d={requestNumber:n.requestNumber||"",requestId:e,customerName:n.customerName||"",customerEmail:n.customerEmail||"",partnerName:n.partnerName||"",partnerEmail:n.partnerEmail||"",branchName:n.branchName||"",branchAddress:n.branchAddress||"",serviceName:n.serviceName||"",categoryName:n.categoryName||"",status:"rejected",rejectionReason:t},m=await c.configurationService.getSlaNotificationRecipients();if(0===m.length)return void o.logger.warn("No admin emails configured for rejection notifications");for(let t of m)try{let r=await u.default.sendRequestRejectedEmail(d,t,"en");r.success||o.logger.error("Failed to send rejection email to admin",{error:r.error,recipient:t,requestId:e})}catch(r){o.logger.error("Failed to send rejection email to admin",{error:r,recipient:t,requestId:e})}o.logger.info("Request rejection emails sent to admin team",{requestId:e,recipients:m.length,rejectionReason:t})}catch(t){o.logger.error("Failed to send request rejection emails",{error:t,requestId:e})}}async sendNewRequestEmail(e){try{let t=await s.db.select({requestNumber:a.requests.requestNumber,customerName:a.requests.customerName,customerPhone:a.requests.customerPhone,customerAddress:a.requests.customerAddress,serviceName:a.services.name,categoryName:a.categories.name,pickupOptionName:a.pickupOptionTypes.name}).from(a.requests).leftJoin(a.services,(0,i.eq)(a.requests.serviceId,a.services.id)).leftJoin(a.categories,(0,i.eq)(a.services.categoryId,a.categories.id)).leftJoin(a.pickupOptionTypes,(0,i.eq)(a.requests.pickupOptionId,a.pickupOptionTypes.id)).where((0,i.eq)(a.requests.id,e)).limit(1);if(0===t.length)return void o.logger.warn("Request not found for new request email",{requestId:e});let r=t[0],n=await c.configurationService.getSlaNotificationRecipients();if(0===n.length)return void o.logger.warn("No admin/operational team emails configured for new request notifications");let d={en:{subject:`New Request Submitted - ${r.requestNumber}`,message:`A new service request has been submitted and is waiting for assignment.

Request Number: ${r.requestNumber}
Customer Name: ${r.customerName}
Customer Phone: ${r.customerPhone}
Service: ${r.serviceName}
Category: ${r.categoryName}
Pickup Option: ${r.pickupOptionName}
Location: ${r.customerAddress}

Please log in to the admin portal to assign this request to a partner.`},ar:{subject:`طلب جديد تم تقديمه - ${r.requestNumber}`,message:`تم تقديم طلب خدمة جديد وهو في انتظار التعيين.

رقم الطلب: ${r.requestNumber}
اسم العميل: ${r.customerName}
هاتف العميل: ${r.customerPhone}
الخدمة: ${r.serviceName}
الفئة: ${r.categoryName}
خيار الاستلام: ${r.pickupOptionName}
الموقع: ${r.customerAddress}

يرجى تسجيل الدخول إلى لوحة تحكم المسؤول لتعيين هذا الطلب لشريك.`}};for(let t of n)try{let r=await u.default.sendNotificationEmail(t,d.en.subject,d.en.message,"en");r.success||o.logger.error("Failed to send new request email to recipient",{error:r.error,recipient:t,requestId:e})}catch(r){o.logger.error("Failed to send new request email to recipient",{error:r,recipient:t,requestId:e})}o.logger.info("New request emails sent to admin/operational team",{requestId:e,recipients:n.length})}catch(t){o.logger.error("Failed to send new request emails",{error:t,requestId:e})}}};e.s(["requestService",0,m]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=projects_ticketing-platform_lib_services_requestService_ts_2b57f237._.js.map