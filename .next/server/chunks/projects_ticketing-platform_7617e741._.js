module.exports=[60901,e=>e.a(async(t,r)=>{try{var i=e.i(11797),n=e.i(88707),s=e.i(78156),a=e.i(89722),o=e.i(85278),u=e.i(3781),l=t([i,n,s,a,o]);async function d(e,t){try{let t=e.headers.authorization;if(!t||!t.startsWith("Bearer "))throw new o.AppError("Authentication required",401,o.ErrorCodes.UNAUTHORIZED);let r=t.substring(7),{userId:n}=await i.authService.verifyToken(r),s=await i.authService.getUserProfile(n);return e.user=s,e.userId=s.id,e.roleId=s.roleId,s}catch(t){throw u.logger.error("Authentication failed",{error:t instanceof Error?t.message:"Unknown error",path:e.url}),t}}async function c(e,t,r){try{e.user&&e.roleId||await d(e,t);let i=e.roleId,l=await n.db.select().from(s.rolePermissions).innerJoin(s.permissions,(0,a.eq)(s.permissions.id,s.rolePermissions.permissionId)).where((0,a.and)((0,a.eq)(s.rolePermissions.roleId,i),(0,a.eq)(s.permissions.name,r),(0,a.eq)(s.rolePermissions.isActive,!0),(0,a.eq)(s.rolePermissions.isDeleted,!1),(0,a.eq)(s.permissions.isActive,!0),(0,a.eq)(s.permissions.isDeleted,!1))).limit(1);if(0===l.length)throw new o.AppError(`Permission denied: ${r} required`,403,o.ErrorCodes.FORBIDDEN);u.logger.info("Permission check passed",{userId:e.userId,roleId:i,permission:r})}catch(t){throw u.logger.error("Permission check failed",{error:t instanceof Error?t.message:"Unknown error",userId:e.userId,permission:r,path:e.url}),t}}[i,n,s,a,o]=l.then?(await l)():l,e.s(["requireAuth",()=>d,"requirePermission",()=>c]),r()}catch(e){r(e)}},!1),23268,e=>e.a(async(t,r)=>{try{var i=e.i(88707),n=e.i(78156),s=e.i(89722),a=e.i(3781),o=t([i,n,s]);[i,n,s]=o.then?(await o)():o;let u={SLA_TIMEOUT_MINUTES:"sla_timeout_minutes",OPERATIONAL_TEAM_EMAILS:"operational_team_emails",ADMIN_NOTIFICATION_EMAILS:"admin_notification_emails"};class l{async getGlobalConfig(e){try{let t=await i.db.select({id:n.configurations.id,key:n.configurations.key,value:n.configurations.value,description:n.configurations.description,updatedAt:n.configurations.updatedAt}).from(n.configurations).where((0,s.and)(s.sql`${n.configurations.scope} = 'global'::config_scope_enum`,(0,s.eq)(n.configurations.key,e),(0,s.eq)(n.configurations.isActive,!0),(0,s.eq)(n.configurations.isDeleted,!1))).limit(1);if(0===t.length)return a.logger.debug(`Configuration not found: ${e}`),null;return t[0]}catch(t){throw a.logger.error("Error fetching global config",{key:e,error:t}),t}}async setGlobalConfig(e,t,r,o){try{let u=await i.db.select().from(n.configurations).where((0,s.and)(s.sql`${n.configurations.scope} = 'global'::config_scope_enum`,(0,s.eq)(n.configurations.key,e),(0,s.eq)(n.configurations.isDeleted,!1))).limit(1);if(u.length>0){let l=await i.db.update(n.configurations).set({value:t,description:r||u[0].description,updatedAt:new Date,updatedById:o,isActive:!0}).where((0,s.eq)(n.configurations.id,u[0].id)).returning({id:n.configurations.id,key:n.configurations.key,value:n.configurations.value,description:n.configurations.description,updatedAt:n.configurations.updatedAt});return a.logger.info("Configuration updated",{key:e,userId:o}),l[0]}{let s=await i.db.insert(n.configurations).values({scope:"global",key:e,value:t,description:r||null,createdById:o,updatedById:o,isActive:!0,isDeleted:!1}).returning({id:n.configurations.id,key:n.configurations.key,value:n.configurations.value,description:n.configurations.description,updatedAt:n.configurations.updatedAt});return a.logger.info("Configuration created",{key:e,userId:o}),s[0]}}catch(t){throw a.logger.error("Error setting global config",{key:e,error:t}),t}}async getAllGlobalConfigs(){try{return await i.db.select({id:n.configurations.id,key:n.configurations.key,value:n.configurations.value,description:n.configurations.description,updatedAt:n.configurations.updatedAt}).from(n.configurations).where((0,s.and)(s.sql`${n.configurations.scope} = 'global'::config_scope_enum`,(0,s.eq)(n.configurations.isActive,!0),(0,s.eq)(n.configurations.isDeleted,!1))).orderBy(n.configurations.key)}catch(e){throw a.logger.error("Error fetching all global configs",{error:e}),e}}async deleteGlobalConfig(e,t){try{await i.db.update(n.configurations).set({isDeleted:!0,updatedAt:new Date,updatedById:t}).where((0,s.and)(s.sql`${n.configurations.scope} = 'global'::config_scope_enum`,(0,s.eq)(n.configurations.key,e))),a.logger.info("Configuration deleted",{key:e,userId:t})}catch(t){throw a.logger.error("Error deleting global config",{key:e,error:t}),t}}async getSlaTimeout(){try{let e=await this.getGlobalConfig(u.SLA_TIMEOUT_MINUTES);if(e&&e.value){let t=parseInt(e.value,10);if(!isNaN(t)&&t>0&&t<=60)return t}let t=parseInt(process.env.DEFAULT_SLA_TIMEOUT_MINUTES||"15",10);return isNaN(t)?15:t}catch(e){return a.logger.error("Error getting SLA timeout, using default",{error:e}),15}}async getOperationalTeamEmails(){try{let e=await this.getGlobalConfig(u.OPERATIONAL_TEAM_EMAILS);if(e&&e.value)return e.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);let t=process.env.OPERATIONAL_TEAM_EMAILS||"";if(t)return t.split(",").map(e=>e.trim()).filter(e=>e.length>0);return[]}catch(e){return a.logger.error("Error getting operational team emails",{error:e}),[]}}async getAdminEmails(){try{let e=await i.db.select({email:n.users.email,name:n.users.name,roleName:n.roles.name}).from(n.users).innerJoin(n.roles,(0,s.eq)(n.users.roleId,n.roles.id)).where((0,s.and)((0,s.or)((0,s.eq)(n.users.userType,"admin"),(0,s.inArray)(n.roles.name,["admin","operation"])),(0,s.eq)(n.users.isActive,!0),(0,s.eq)(n.users.isDeleted,!1),(0,s.eq)(n.roles.isActive,!0),(0,s.eq)(n.roles.isDeleted,!1))),t=[...new Set(e.map(e=>e.email))];if(t.length>0)return a.logger.info("Retrieved admin emails from database",{count:t.length,emails:t.map(e=>e.replace(/^(.{3}).*(@.*)$/,"$1***$2"))}),t;let r=await this.getGlobalConfig(u.ADMIN_NOTIFICATION_EMAILS);if(r&&r.value){let e=r.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);if(e.length>0)return a.logger.info("Using admin emails from config",{count:e.length}),e}let o=process.env.ADMIN_EMAIL||"";if(o)return a.logger.info("Using admin email from environment variable"),[o];return a.logger.warn("No admin emails found in database, config, or environment"),[]}catch(t){a.logger.error("Error getting admin emails",{error:t instanceof Error?t.message:"Unknown error",stack:t instanceof Error?t.stack:void 0});let e=process.env.ADMIN_EMAIL||"";if(e)return a.logger.info("Using emergency fallback to environment variable"),[e];return[]}}async getSlaNotificationRecipients(){try{let e=await this.getAdminEmails(),t=await this.getOperationalTeamEmails(),r=[...e,...t];return Array.from(new Set(r))}catch(e){return a.logger.error("Error getting SLA notification recipients",{error:e}),[]}}}let d=new l;e.s(["CONFIG_KEYS",0,u,"ConfigurationService",()=>l,"configurationService",0,d]),r()}catch(e){r(e)}},!1),96548,e=>e.a(async(t,r)=>{try{var i=e.i(97010),n=t([i]);[i]=n.then?(await n)():n;let s=i.z.object({categoryId:i.z.number().int().positive("Category ID must be positive"),serviceId:i.z.number().int().positive("Service ID must be positive").optional(),pickupOptionId:i.z.number().int().positive("Pickup option ID must be positive"),customerName:i.z.string().min(2,"Customer name must be at least 2 characters"),customerPhone:i.z.string().min(10,"Phone number must be at least 10 characters"),customerLat:i.z.number().min(-90).max(90,"Latitude must be between -90 and 90"),customerLng:i.z.number().min(-180).max(180,"Longitude must be between -180 and 180"),customerAddress:i.z.string().min(5,"Address must be at least 5 characters")}),a=i.z.object({partnerId:i.z.number().int().positive("Partner ID must be positive"),branchId:i.z.number().int().positive("Branch ID must be positive")}),o=i.z.object({status:i.z.enum(["confirmed","in_progress","completed","rejected"]),notes:i.z.string().optional(),rejectionReason:i.z.string().optional().refine(()=>!0,"Rejection reason is required when status is rejected")}),u=i.z.object({rating:i.z.number().int().min(1).max(5,"Rating must be between 1 and 5"),feedback:i.z.string().optional()}),l=i.z.preprocess(e=>{if(null==e||""===e)return;let t=Number(e);return isNaN(t)?void 0:t},i.z.number().optional()),d=i.z.preprocess(e=>{if(null==e||""===e)return 1;let t=Number(e);return isNaN(t)?1:t},i.z.number()),c=i.z.object({customerName:i.z.string().optional(),customerPhone:i.z.string().optional(),status:i.z.enum(["submitted","assigned","confirmed","in_progress","completed","closed","rejected","unassigned"]).optional(),categoryId:l.refine(e=>void 0===e||e>0,{message:"Category ID must be positive"}),partnerId:l.refine(e=>void 0===e||e>0,{message:"Partner ID must be positive"}),branchId:l.refine(e=>void 0===e||e>0,{message:"Branch ID must be positive"}),dateFrom:i.z.string().datetime().optional(),dateTo:i.z.string().datetime().optional(),page:d.refine(e=>e>=1,{message:"Page must be at least 1"}),limit:d.refine(e=>e>=1&&e<=100,{message:"Limit must be between 1 and 100"}),pickupOptionId:l.refine(e=>void 0===e||e>0,{message:"Pickup option ID must be positive"}),serviceId:l.refine(e=>void 0===e||e>0,{message:"Service ID must be positive"}),sortBy:i.z.enum(["createdAt","updatedAt","submittedAt","assignedAt","completedAt"]).default("createdAt"),sortOrder:i.z.enum(["asc","desc"]).default("desc")});i.z.object({query:i.z.string().min(1,"Search query is required"),filters:c.optional()}),e.s(["assignRequestSchema",0,a,"createRequestSchema",0,s,"rateRequestSchema",0,u,"requestFiltersSchema",0,c,"updateRequestStatusSchema",0,o]),r()}catch(e){r(e)}},!1),89387,e=>e.a(async(t,r)=>{try{var i=e.i(96548),n=e.i(13574),s=e.i(60901),a=e.i(85278),o=e.i(3781),u=t([i,n,s,a]);async function l(e,t){if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});try{await (0,s.requireAuth)(e,t),await (0,s.requirePermission)(e,t,"request_assign");let r=e.userId,u=parseInt(e.query.id);if(isNaN(u))return(0,a.sendErrorResponse)(t,{message:"Invalid request ID",code:"VALIDATION_ERROR",statusCode:400});let l=i.assignRequestSchema.parse(e.body),d=await n.requestService.assignRequest(u,l,r);return o.logger.apiResponse(e.method,e.url,200,0,r,e.headers["x-request-id"]),(0,a.sendSuccessResponse)(t,d)}catch(i){let r=(0,a.handleApiError)(i);return o.logger.error("Assign request API error",{error:r.message,code:r.code,requestId:e.headers["x-request-id"]}),(0,a.sendErrorResponse)(t,r)}}[i,n,s,a]=u.then?(await u)():u,e.s(["default",()=>l]),r()}catch(e){r(e)}},!1),81507,e=>e.a(async(t,r)=>{try{var i=e.i(89304),n=e.i(36438),s=e.i(90950),a=e.i(17885),o=e.i(89387),u=e.i(8911),l=e.i(95011),d=e.i(40430),c=t([o]);[o]=c.then?(await c)():c;let m=(0,a.hoist)(o,"default"),p=(0,a.hoist)(o,"config"),f=new s.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/admin/requests/[id]/assign",pathname:"/api/admin/requests/[id]/assign",bundlePath:"",filename:""},userland:o,distDir:".next",relativeProjectDir:""});async function g(e,t,r){f.isDev&&(0,d.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/admin/requests/[id]/assign";n=n.replace(/\/index$/,"")||"/";let s=await f.prepare(e,t,{srcPage:n});if(!s){t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:a,params:o,prerenderManifest:c,routerServerContext:g}=s;try{let r=e.method||"GET",i=(0,u.getTracer)(),s=i.getActiveScopeSpan(),d=f.instrumentationOnRequestError.bind(f),m=async s=>f.render(e,t,{query:{...a,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:f.isDev,page:"/api/admin/requests/[id]/assign",internalRevalidate:null==g?void 0:g.revalidate,onError:(...t)=>d(e,...t)}).finally(()=>{if(!s)return;s.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=i.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=e.get("next.route");if(a){let e=`${r} ${a}`;s.setAttributes({"next.route":a,"http.route":a,"next.span_name":e}),s.updateName(e)}else s.updateName(`${r} ${n}`)});s?await m(s):await i.withPropagatedContext(e.headers,()=>i.trace(l.BaseServerSpan.handleRequest,{spanName:`${r} ${n}`,kind:u.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},m))}catch(e){if(f.isDev)throw e;(0,i.sendError)(t,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,p,"default",0,m,"handler",()=>g]),r()}catch(e){r(e)}},!1),69182,e=>{e.v(e=>Promise.resolve().then(()=>e(23268)))},88749,e=>{e.v(e=>Promise.resolve().then(()=>e(85278)))}];

//# sourceMappingURL=projects_ticketing-platform_7617e741._.js.map