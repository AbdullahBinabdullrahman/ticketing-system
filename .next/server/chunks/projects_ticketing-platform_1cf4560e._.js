module.exports=[23268,e=>e.a(async(t,i)=>{try{var r=e.i(88707),a=e.i(78156),n=e.i(89722),o=e.i(3781),s=t([r,a,n]);[r,a,n]=s.then?(await s)():s;let l={SLA_TIMEOUT_MINUTES:"sla_timeout_minutes",OPERATIONAL_TEAM_EMAILS:"operational_team_emails",ADMIN_NOTIFICATION_EMAILS:"admin_notification_emails"};class u{async getGlobalConfig(e){try{let t=await r.db.select({id:a.configurations.id,key:a.configurations.key,value:a.configurations.value,description:a.configurations.description,updatedAt:a.configurations.updatedAt}).from(a.configurations).where((0,n.and)(n.sql`${a.configurations.scope} = 'global'::config_scope_enum`,(0,n.eq)(a.configurations.key,e),(0,n.eq)(a.configurations.isActive,!0),(0,n.eq)(a.configurations.isDeleted,!1))).limit(1);if(0===t.length)return o.logger.debug(`Configuration not found: ${e}`),null;return t[0]}catch(t){throw o.logger.error("Error fetching global config",{key:e,error:t}),t}}async setGlobalConfig(e,t,i,s){try{let l=await r.db.select().from(a.configurations).where((0,n.and)(n.sql`${a.configurations.scope} = 'global'::config_scope_enum`,(0,n.eq)(a.configurations.key,e),(0,n.eq)(a.configurations.isDeleted,!1))).limit(1);if(l.length>0){let u=await r.db.update(a.configurations).set({value:t,description:i||l[0].description,updatedAt:new Date,updatedById:s,isActive:!0}).where((0,n.eq)(a.configurations.id,l[0].id)).returning({id:a.configurations.id,key:a.configurations.key,value:a.configurations.value,description:a.configurations.description,updatedAt:a.configurations.updatedAt});return o.logger.info("Configuration updated",{key:e,userId:s}),u[0]}{let n=await r.db.insert(a.configurations).values({scope:"global",key:e,value:t,description:i||null,createdById:s,updatedById:s,isActive:!0,isDeleted:!1}).returning({id:a.configurations.id,key:a.configurations.key,value:a.configurations.value,description:a.configurations.description,updatedAt:a.configurations.updatedAt});return o.logger.info("Configuration created",{key:e,userId:s}),n[0]}}catch(t){throw o.logger.error("Error setting global config",{key:e,error:t}),t}}async getAllGlobalConfigs(){try{return await r.db.select({id:a.configurations.id,key:a.configurations.key,value:a.configurations.value,description:a.configurations.description,updatedAt:a.configurations.updatedAt}).from(a.configurations).where((0,n.and)(n.sql`${a.configurations.scope} = 'global'::config_scope_enum`,(0,n.eq)(a.configurations.isActive,!0),(0,n.eq)(a.configurations.isDeleted,!1))).orderBy(a.configurations.key)}catch(e){throw o.logger.error("Error fetching all global configs",{error:e}),e}}async deleteGlobalConfig(e,t){try{await r.db.update(a.configurations).set({isDeleted:!0,updatedAt:new Date,updatedById:t}).where((0,n.and)(n.sql`${a.configurations.scope} = 'global'::config_scope_enum`,(0,n.eq)(a.configurations.key,e))),o.logger.info("Configuration deleted",{key:e,userId:t})}catch(t){throw o.logger.error("Error deleting global config",{key:e,error:t}),t}}async getSlaTimeout(){try{let e=await this.getGlobalConfig(l.SLA_TIMEOUT_MINUTES);if(e&&e.value){let t=parseInt(e.value,10);if(!isNaN(t)&&t>0&&t<=60)return t}let t=parseInt(process.env.DEFAULT_SLA_TIMEOUT_MINUTES||"15",10);return isNaN(t)?15:t}catch(e){return o.logger.error("Error getting SLA timeout, using default",{error:e}),15}}async getOperationalTeamEmails(){try{let e=await this.getGlobalConfig(l.OPERATIONAL_TEAM_EMAILS);if(e&&e.value)return e.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);let t=process.env.OPERATIONAL_TEAM_EMAILS||"";if(t)return t.split(",").map(e=>e.trim()).filter(e=>e.length>0);return[]}catch(e){return o.logger.error("Error getting operational team emails",{error:e}),[]}}async getAdminEmails(){try{let e=await r.db.select({email:a.users.email,name:a.users.name,roleName:a.roles.name}).from(a.users).innerJoin(a.roles,(0,n.eq)(a.users.roleId,a.roles.id)).where((0,n.and)((0,n.or)((0,n.eq)(a.users.userType,"admin"),(0,n.inArray)(a.roles.name,["admin","operation"])),(0,n.eq)(a.users.isActive,!0),(0,n.eq)(a.users.isDeleted,!1),(0,n.eq)(a.roles.isActive,!0),(0,n.eq)(a.roles.isDeleted,!1))),t=[...new Set(e.map(e=>e.email))];if(t.length>0)return o.logger.info("Retrieved admin emails from database",{count:t.length,emails:t.map(e=>e.replace(/^(.{3}).*(@.*)$/,"$1***$2"))}),t;let i=await this.getGlobalConfig(l.ADMIN_NOTIFICATION_EMAILS);if(i&&i.value){let e=i.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);if(e.length>0)return o.logger.info("Using admin emails from config",{count:e.length}),e}let s=process.env.ADMIN_EMAIL||"";if(s)return o.logger.info("Using admin email from environment variable"),[s];return o.logger.warn("No admin emails found in database, config, or environment"),[]}catch(t){o.logger.error("Error getting admin emails",{error:t instanceof Error?t.message:"Unknown error",stack:t instanceof Error?t.stack:void 0});let e=process.env.ADMIN_EMAIL||"";if(e)return o.logger.info("Using emergency fallback to environment variable"),[e];return[]}}async getSlaNotificationRecipients(){try{let e=await this.getAdminEmails(),t=await this.getOperationalTeamEmails(),i=[...e,...t];return Array.from(new Set(i))}catch(e){return o.logger.error("Error getting SLA notification recipients",{error:e}),[]}}}let d=new u;e.s(["CONFIG_KEYS",0,l,"ConfigurationService",()=>u,"configurationService",0,d]),i()}catch(e){i(e)}},!1),86698,e=>e.a(async(t,i)=>{try{var r=e.i(97010),a=t([r]);[r]=a.then?(await a)():a;let n=r.z.enum(["sla_timeout_minutes","operational_team_emails","admin_notification_emails"]),o=r.z.object({key:n,value:r.z.string().min(1,"Value is required"),description:r.z.string().optional()}),s=r.z.object({value:r.z.string().min(1,"Value is required"),description:r.z.string().optional()}),l=r.z.object({key:r.z.literal("sla_timeout_minutes"),value:r.z.string().refine(e=>{let t=parseInt(e,10);return!isNaN(t)&&t>=1&&t<=60},{message:"SLA timeout must be between 1 and 60 minutes"}),description:r.z.string().optional()}),u=r.z.object({key:r.z.enum(["operational_team_emails","admin_notification_emails"]),value:r.z.string().refine(e=>{let t=e.split(",").map(e=>e.trim()),i=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return t.every(e=>0===e.length||i.test(e))},{message:"Invalid email format. Use comma-separated email addresses"}),description:r.z.string().optional()});r.z.object({key:n.optional()}),e.s(["ConfigurationKeys",0,n,"createConfigurationSchema",0,o,"emailConfigSchema",0,u,"slaTimeoutConfigSchema",0,l,"updateConfigurationSchema",0,s]),i()}catch(e){i(e)}},!1),82761,e=>e.a(async(t,i)=>{try{var r=e.i(23268),a=e.i(11797),n=e.i(86698),o=e.i(85278),s=e.i(3781),l=t([r,a,n,o]);async function u(e,t){if("GET"!==e.method&&"PATCH"!==e.method&&"DELETE"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let i=e.headers.authorization;if(!i||!i.startsWith("Bearer "))return(0,o.sendErrorResponse)(t,{message:"Authorization header missing or invalid",code:"AUTHENTICATION_ERROR",statusCode:401});let l=i.substring(7),{userId:u}=await a.authService.verifyToken(l),d=await a.authService.getUserProfile(u);if("admin"!==d.userType)return(0,o.sendErrorResponse)(t,{message:"Access denied - Admin required",code:"AUTHORIZATION_ERROR",statusCode:403});let c=e.query.key;if(!n.ConfigurationKeys.safeParse(c).success)return(0,o.sendErrorResponse)(t,{message:"Invalid configuration key",code:"VALIDATION_ERROR",statusCode:400});if("GET"===e.method){let i=await r.configurationService.getGlobalConfig(c);if(!i)throw new o.AppError("Configuration not found",404,o.ErrorCodes.NOT_FOUND);return s.logger.apiResponse(e.method,e.url,200,0,u,e.headers["x-request-id"]),(0,o.sendSuccessResponse)(t,i)}if("PATCH"===e.method){let i,a=n.updateConfigurationSchema.safeParse(e.body);if(!a.success)return(0,o.sendErrorResponse)(t,{message:"Validation error",code:"VALIDATION_ERROR",statusCode:400,details:{message:a.error.message}});let l={...e.body,key:c};if("sla_timeout_minutes"===c){let e=n.slaTimeoutConfigSchema.safeParse(l);if(!e.success)return(0,o.sendErrorResponse)(t,{message:"SLA timeout validation error",code:"VALIDATION_ERROR",statusCode:400,details:{message:e.error.message}});i=e.data}else if("operational_team_emails"===c||"admin_notification_emails"===c){let e=n.emailConfigSchema.safeParse(l);if(!e.success)return(0,o.sendErrorResponse)(t,{message:"Email configuration validation error",code:"VALIDATION_ERROR",statusCode:400,details:{message:e.error.message}});i=e.data}else i={...a.data,key:c};let d=await r.configurationService.setGlobalConfig(c,i.value,i.description,u);return s.logger.apiResponse(e.method,e.url,200,0,u,e.headers["x-request-id"]),(0,o.sendSuccessResponse)(t,d)}if("DELETE"===e.method)return await r.configurationService.deleteGlobalConfig(c,u),s.logger.apiResponse(e.method,e.url,200,0,u,e.headers["x-request-id"]),(0,o.sendSuccessResponse)(t,{message:"Configuration deleted successfully"})}catch(r){let i=(0,o.handleApiError)(r);return s.logger.error("Admin configuration detail API error",{error:i.message,code:i.code,requestId:e.headers["x-request-id"]}),(0,o.sendErrorResponse)(t,i)}}[r,a,n,o]=l.then?(await l)():l,e.s(["default",()=>u]),i()}catch(e){i(e)}},!1),83259,e=>e.a(async(t,i)=>{try{var r=e.i(89304),a=e.i(36438),n=e.i(90950),o=e.i(17885),s=e.i(82761),l=e.i(8911),u=e.i(95011),d=e.i(40430),c=t([s]);[s]=c.then?(await c)():c;let f=(0,o.hoist)(s,"default"),m=(0,o.hoist)(s,"config"),p=new n.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/admin/configurations/[key]",pathname:"/api/admin/configurations/[key]",bundlePath:"",filename:""},userland:s,distDir:".next",relativeProjectDir:""});async function g(e,t,i){p.isDev&&(0,d.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/admin/configurations/[key]";a=a.replace(/\/index$/,"")||"/";let n=await p.prepare(e,t,{srcPage:a});if(!n){t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve());return}let{query:o,params:s,prerenderManifest:c,routerServerContext:g}=n;try{let i=e.method||"GET",r=(0,l.getTracer)(),n=r.getActiveScopeSpan(),d=p.instrumentationOnRequestError.bind(p),f=async n=>p.render(e,t,{query:{...o,...s},params:s,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:p.isDev,page:"/api/admin/configurations/[key]",internalRevalidate:null==g?void 0:g.revalidate,onError:(...t)=>d(e,...t)}).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=r.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=e.get("next.route");if(o){let e=`${i} ${o}`;n.setAttributes({"next.route":o,"http.route":o,"next.span_name":e}),n.updateName(e)}else n.updateName(`${i} ${a}`)});n?await f(n):await r.withPropagatedContext(e.headers,()=>r.trace(u.BaseServerSpan.handleRequest,{spanName:`${i} ${a}`,kind:l.SpanKind.SERVER,attributes:{"http.method":i,"http.target":e.url}},f))}catch(e){if(p.isDev)throw e;(0,r.sendError)(t,500,"Internal Server Error")}finally{null==i.waitUntil||i.waitUntil.call(i,Promise.resolve())}}e.s(["config",0,m,"default",0,f,"handler",()=>g]),i()}catch(e){i(e)}},!1)];

//# sourceMappingURL=projects_ticketing-platform_1cf4560e._.js.map