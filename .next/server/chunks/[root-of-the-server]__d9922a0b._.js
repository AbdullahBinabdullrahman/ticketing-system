module.exports=[70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},20270,(e,t,r)=>{t.exports=e.x("dotenv/config",()=>require("dotenv/config"))},21783,e=>e.a(async(t,r)=>{try{let t=await e.y("drizzle-orm/postgres-js");e.n(t),r()}catch(e){r(e)}},!0),55443,e=>e.a(async(t,r)=>{try{let t=await e.y("postgres");e.n(t),r()}catch(e){r(e)}},!0),88707,e=>e.a(async(t,r)=>{try{e.i(20270);var n=e.i(21783),i=e.i(55443),a=t([n,i]);[n,i]=a.then?(await a)():a;let s=process.env.DATABASE_URL;if(!s)throw Error("DATABASE_URL environment variable is not set");let o=(0,i.default)(s,{prepare:!1,max:10,idle_timeout:20,connect_timeout:30,max_lifetime:1800,connection:{application_name:"ticketing-system"},onnotice:()=>{},debug:void 0}),l=(0,n.drizzle)(o);"undefined"!=typeof process&&(process.on("SIGTERM",async()=>{console.log("SIGTERM received, closing database connections..."),await o.end({timeout:5})}),process.on("SIGINT",async()=>{console.log("SIGINT received, closing database connections..."),await o.end({timeout:5})})),e.s(["db",0,l]),r()}catch(e){r(e)}},!1),3781,e=>{"use strict";class t{isDevelopment=!1;logLevel=process.env.LOG_LEVEL||"info";shouldLog(e){let t={debug:0,info:1,warn:2,error:3};return t[e]>=t[this.logLevel]}formatLog(e){let{level:t,message:r,timestamp:n,context:i,userId:a,requestId:s}=e,o=`[${n}] [${t.toUpperCase()}]`;return a&&(o+=` [USER:${a}]`),s&&(o+=` [REQ:${s}]`),o+=` ${r}`,i&&Object.keys(i).length>0&&(o+=` | Context: ${JSON.stringify(i)}`),o}log(e,t,r,n,i){if(!this.shouldLog(e))return;let a={level:e,message:t,timestamp:new Date().toISOString(),context:r,userId:n,requestId:i},s=this.formatLog(a);this.isDevelopment?console.log(`${{debug:"\x1b[36m",info:"\x1b[32m",warn:"\x1b[33m",error:"\x1b[31m"}[e]}${s}\x1b[0m`):console.log(JSON.stringify(a))}debug(e,t,r,n){this.log("debug",e,t,r,n)}info(e,t,r,n){this.log("info",e,t,r,n)}warn(e,t,r,n){this.log("warn",e,t,r,n)}error(e,t,r,n){this.log("error",e,t,r,n)}apiRequest(e,t,r,n,i){this.info(`API Request: ${e} ${t}`,{method:e,url:t,...r},n,i)}apiResponse(e,t,r,n,i,a){this.info(`API Response: ${e} ${t} - ${r} (${n}ms)`,{method:e,url:t,statusCode:r,duration:n},i,a)}databaseQuery(e,t,r,n){this.debug(`Database Query: ${e} (${t}ms)`,{query:e,duration:t},r,n)}authEvent(e,t,r,n){this.info(`Auth Event: ${e}`,{event:e,...r},t,n)}businessEvent(e,t,r,n,i,a){this.info(`Business Event: ${e}`,{event:e,entityType:t,entityId:r,...i},n,a)}errorEvent(e,t,r,n){this.error(`Error Event: ${e.message}`,{error:e.message,stack:e.stack,...t},r,n)}}let r=new t;e.s(["default",0,r,"logger",0,r])},23268,e=>e.a(async(t,r)=>{try{var n=e.i(88707),i=e.i(78156),a=e.i(89722),s=e.i(3781),o=t([n,i,a]);[n,i,a]=o.then?(await o)():o;let l={SLA_TIMEOUT_MINUTES:"sla_timeout_minutes",OPERATIONAL_TEAM_EMAILS:"operational_team_emails",ADMIN_NOTIFICATION_EMAILS:"admin_notification_emails"};class u{async getGlobalConfig(e){try{let t=await n.db.select({id:i.configurations.id,key:i.configurations.key,value:i.configurations.value,description:i.configurations.description,updatedAt:i.configurations.updatedAt}).from(i.configurations).where((0,a.and)(a.sql`${i.configurations.scope} = 'global'::config_scope_enum`,(0,a.eq)(i.configurations.key,e),(0,a.eq)(i.configurations.isActive,!0),(0,a.eq)(i.configurations.isDeleted,!1))).limit(1);if(0===t.length)return s.logger.debug(`Configuration not found: ${e}`),null;return t[0]}catch(t){throw s.logger.error("Error fetching global config",{key:e,error:t}),t}}async setGlobalConfig(e,t,r,o){try{let l=await n.db.select().from(i.configurations).where((0,a.and)(a.sql`${i.configurations.scope} = 'global'::config_scope_enum`,(0,a.eq)(i.configurations.key,e),(0,a.eq)(i.configurations.isDeleted,!1))).limit(1);if(l.length>0){let u=await n.db.update(i.configurations).set({value:t,description:r||l[0].description,updatedAt:new Date,updatedById:o,isActive:!0}).where((0,a.eq)(i.configurations.id,l[0].id)).returning({id:i.configurations.id,key:i.configurations.key,value:i.configurations.value,description:i.configurations.description,updatedAt:i.configurations.updatedAt});return s.logger.info("Configuration updated",{key:e,userId:o}),u[0]}{let a=await n.db.insert(i.configurations).values({scope:"global",key:e,value:t,description:r||null,createdById:o,updatedById:o,isActive:!0,isDeleted:!1}).returning({id:i.configurations.id,key:i.configurations.key,value:i.configurations.value,description:i.configurations.description,updatedAt:i.configurations.updatedAt});return s.logger.info("Configuration created",{key:e,userId:o}),a[0]}}catch(t){throw s.logger.error("Error setting global config",{key:e,error:t}),t}}async getAllGlobalConfigs(){try{return await n.db.select({id:i.configurations.id,key:i.configurations.key,value:i.configurations.value,description:i.configurations.description,updatedAt:i.configurations.updatedAt}).from(i.configurations).where((0,a.and)(a.sql`${i.configurations.scope} = 'global'::config_scope_enum`,(0,a.eq)(i.configurations.isActive,!0),(0,a.eq)(i.configurations.isDeleted,!1))).orderBy(i.configurations.key)}catch(e){throw s.logger.error("Error fetching all global configs",{error:e}),e}}async deleteGlobalConfig(e,t){try{await n.db.update(i.configurations).set({isDeleted:!0,updatedAt:new Date,updatedById:t}).where((0,a.and)(a.sql`${i.configurations.scope} = 'global'::config_scope_enum`,(0,a.eq)(i.configurations.key,e))),s.logger.info("Configuration deleted",{key:e,userId:t})}catch(t){throw s.logger.error("Error deleting global config",{key:e,error:t}),t}}async getSlaTimeout(){try{let e=await this.getGlobalConfig(l.SLA_TIMEOUT_MINUTES);if(e&&e.value){let t=parseInt(e.value,10);if(!isNaN(t)&&t>0&&t<=60)return t}let t=parseInt(process.env.DEFAULT_SLA_TIMEOUT_MINUTES||"15",10);return isNaN(t)?15:t}catch(e){return s.logger.error("Error getting SLA timeout, using default",{error:e}),15}}async getOperationalTeamEmails(){try{let e=await this.getGlobalConfig(l.OPERATIONAL_TEAM_EMAILS);if(e&&e.value)return e.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);let t=process.env.OPERATIONAL_TEAM_EMAILS||"";if(t)return t.split(",").map(e=>e.trim()).filter(e=>e.length>0);return[]}catch(e){return s.logger.error("Error getting operational team emails",{error:e}),[]}}async getAdminEmails(){try{let e=await n.db.select({email:i.users.email,name:i.users.name,roleName:i.roles.name}).from(i.users).innerJoin(i.roles,(0,a.eq)(i.users.roleId,i.roles.id)).where((0,a.and)((0,a.or)((0,a.eq)(i.users.userType,"admin"),(0,a.inArray)(i.roles.name,["admin","operation"])),(0,a.eq)(i.users.isActive,!0),(0,a.eq)(i.users.isDeleted,!1),(0,a.eq)(i.roles.isActive,!0),(0,a.eq)(i.roles.isDeleted,!1))),t=[...new Set(e.map(e=>e.email))];if(t.length>0)return s.logger.info("Retrieved admin emails from database",{count:t.length,emails:t.map(e=>e.replace(/^(.{3}).*(@.*)$/,"$1***$2"))}),t;let r=await this.getGlobalConfig(l.ADMIN_NOTIFICATION_EMAILS);if(r&&r.value){let e=r.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);if(e.length>0)return s.logger.info("Using admin emails from config",{count:e.length}),e}let o=process.env.ADMIN_EMAIL||"";if(o)return s.logger.info("Using admin email from environment variable"),[o];return s.logger.warn("No admin emails found in database, config, or environment"),[]}catch(t){s.logger.error("Error getting admin emails",{error:t instanceof Error?t.message:"Unknown error",stack:t instanceof Error?t.stack:void 0});let e=process.env.ADMIN_EMAIL||"";if(e)return s.logger.info("Using emergency fallback to environment variable"),[e];return[]}}async getSlaNotificationRecipients(){try{let e=await this.getAdminEmails(),t=await this.getOperationalTeamEmails(),r=[...e,...t];return Array.from(new Set(r))}catch(e){return s.logger.error("Error getting SLA notification recipients",{error:e}),[]}}}let d=new u;e.s(["CONFIG_KEYS",0,l,"ConfigurationService",()=>u,"configurationService",0,d]),r()}catch(e){r(e)}},!1),12475,e=>e.a(async(t,r)=>{try{var n=e.i(88707),i=e.i(78156),a=e.i(89722),s=e.i(48841),o=e.i(23268),l=e.i(3781),u=t([n,i,a,o]);[n,i,a,o]=u.then?(await u)():u;let d=parseInt(process.env.SYSTEM_USER_ID||"1"),c=new class{async checkAndUnassignExpired(){let e=new Date;try{let t=await n.db.select({id:i.requests.id,requestNumber:i.requests.requestNumber,partnerId:i.requests.partnerId,branchId:i.requests.branchId,assignedByUserId:i.requests.assignedByUserId,assignedAt:i.requests.assignedAt,slaDeadline:i.requests.slaDeadline}).from(i.requests).where((0,a.and)((0,a.eq)(i.requests.status,"assigned"),(0,a.lt)(i.requests.slaDeadline,e)));if(0===t.length)return l.default.debug("[SLA] No expired requests found"),0;l.default.info(`[SLA] Found ${t.length} expired requests`);let r=0;for(let n of t)try{await this.unassignRequest(n,e),r++,l.default.info(`[SLA] Successfully unassigned request ${n.requestNumber}`)}catch(e){l.default.error(`[SLA] Failed to unassign request ${n.requestNumber}:`,e)}return r}catch(e){throw l.default.error("[SLA] Error in checkAndUnassignExpired:",e),e}}async unassignRequest(e,t){await n.db.transaction(async r=>{await r.update(i.requests).set({status:"unassigned",partnerId:null,branchId:null,assignedAt:null,slaDeadline:null,updatedById:d,updatedAt:t}).where((0,a.eq)(i.requests.id,e.id));let n=await o.configurationService.getSlaTimeout();await r.insert(i.requestAssignments).values({requestId:e.id,partnerId:e.partnerId,branchId:e.branchId,assignedByUserId:e.assignedByUserId,assignedAt:"string"==typeof e.assignedAt?new Date(e.assignedAt):e.assignedAt,respondedAt:t,response:"timeout",rejectionReason:`Auto-unassigned: No response within ${n}-minute SLA`,isActive:!0}),await r.insert(i.requestStatusLog).values({requestId:e.id,status:"unassigned",changedById:d,notes:`SLA timeout - no partner response within ${n} minutes`,timestamp:t,createdById:d,isActive:!0})});try{let t="Unknown Partner";if(e.partnerId){let r=await n.db.select({name:i.partners.name}).from(i.partners).where((0,a.eq)(i.partners.id,e.partnerId)).limit(1);r.length>0&&(t=r[0].name)}let r=await o.configurationService.getSlaNotificationRecipients();r.length>0?await s.default.sendSlaTimeoutEmail({requestNumber:e.requestNumber,partnerName:t,recipients:r,slaDeadline:e.slaDeadline,assignedAt:e.assignedAt}):l.default.warn(`[SLA] No notification recipients configured for request ${e.requestNumber}`)}catch(t){l.default.error(`[SLA] Failed to send timeout email for ${e.requestNumber}:`,t)}}};e.s(["slaMonitorService",0,c]),r()}catch(e){r(e)}},!1),56622,e=>e.a(async(t,r)=>{try{var n=e.i(12475),i=e.i(3781),a=t([n]);async function s(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let r=e.headers["x-cron-secret"];if(!r||r!==process.env.CRON_SECRET)return i.default.warn("[CRON] Unauthorized SLA check attempt",{ip:e.headers["x-forwarded-for"]||e.socket.remoteAddress,userAgent:e.headers["user-agent"]}),t.status(401).json({error:"Unauthorized"});try{let e=Date.now(),r=await n.slaMonitorService.checkAndUnassignExpired(),a=Date.now()-e;return i.default.info("[CRON] SLA check completed",{unassignedCount:r,durationMs:a}),t.status(200).json({success:!0,unassignedCount:r,timestamp:new Date().toISOString(),durationMs:a})}catch(e){return i.default.error("[CRON] SLA check failed:",e),t.status(500).json({success:!1,error:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()})}}[n]=a.then?(await a)():a,e.s(["default",()=>s]),r()}catch(e){r(e)}},!1),19868,e=>e.a(async(t,r)=>{try{var n=e.i(89304),i=e.i(36438),a=e.i(90950),s=e.i(17885),o=e.i(56622),l=e.i(8911),u=e.i(95011),d=e.i(40430),c=t([o]);[o]=c.then?(await c)():c;let f=(0,s.hoist)(o,"default"),p=(0,s.hoist)(o,"config"),m=new a.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/cron/sla-check",pathname:"/api/cron/sla-check",bundlePath:"",filename:""},userland:o,distDir:".next",relativeProjectDir:""});async function g(e,t,r){m.isDev&&(0,d.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/cron/sla-check";i=i.replace(/\/index$/,"")||"/";let a=await m.prepare(e,t,{srcPage:i});if(!a){t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:s,params:o,prerenderManifest:c,routerServerContext:g}=a;try{let r=e.method||"GET",n=(0,l.getTracer)(),a=n.getActiveScopeSpan(),d=m.instrumentationOnRequestError.bind(m),f=async a=>m.render(e,t,{query:{...s,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:m.isDev,page:"/api/cron/sla-check",internalRevalidate:null==g?void 0:g.revalidate,onError:(...t)=>d(e,...t)}).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=n.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=e.get("next.route");if(s){let e=`${r} ${s}`;a.setAttributes({"next.route":s,"http.route":s,"next.span_name":e}),a.updateName(e)}else a.updateName(`${r} ${i}`)});a?await f(a):await n.withPropagatedContext(e.headers,()=>n.trace(u.BaseServerSpan.handleRequest,{spanName:`${r} ${i}`,kind:l.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},f))}catch(e){if(m.isDev)throw e;(0,n.sendError)(t,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,p,"default",0,f,"handler",()=>g]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__d9922a0b._.js.map