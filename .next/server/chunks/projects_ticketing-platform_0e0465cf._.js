module.exports=[82280,e=>e.a(async(r,t)=>{try{var a=e.i(29229),s=e.i(88707),n=e.i(78156),i=e.i(89722),o=e.i(56732),l=e.i(3781),d=r([a,s,n,i]);async function u(e){try{let r=await s.db.select().from(n.partners).where((0,i.and)((0,i.eq)(n.partners.id,e.partnerId),(0,i.eq)(n.partners.isActive,!0),(0,i.eq)(n.partners.isDeleted,!1))).limit(1);if(0===r.length)return{success:!1,error:"Partner not found or inactive"};if((await s.db.select().from(n.users).where((0,i.and)((0,i.eq)(n.users.email,e.email),(0,i.eq)(n.users.isDeleted,!1))).limit(1)).length>0)return{success:!1,error:"Email already exists"};let t=await s.db.select().from(n.roles).where((0,i.eq)(n.roles.name,"partner")).limit(1);if(0===t.length)return{success:!1,error:"Partner role not found"};let d=e.password||function(){let e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*",r="";r+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(26*Math.random())],r+="abcdefghijklmnopqrstuvwxyz"[Math.floor(26*Math.random())],r+="0123456789"[Math.floor(10*Math.random())],r+="!@#$%^&*"[Math.floor(8*Math.random())];for(let t=r.length;t<12;t++)r+=e[Math.floor(Math.random()*e.length)];return r.split("").sort(()=>Math.random()-.5).join("")}(),u=await a.default.hash(d,12),c=!e.password,m=await s.db.insert(n.users).values({name:e.name,email:e.email,phone:e.phone||null,password:u,roleId:t[0].id,userType:"partner",partnerId:e.partnerId,languagePreference:e.language||"en",isActive:!0,isDeleted:!1,emailVerifiedAt:new Date,createdAt:new Date}).returning();if(!1!==e.sendWelcomeEmail&&c)try{await o.default.sendWelcomeEmail(e.email,e.name,d,e.language||"en"),l.logger.info("Welcome email sent",{email:e.email,userId:m[0].id})}catch(r){l.logger.error("Failed to send welcome email",{error:r,email:e.email})}return l.logger.info("Partner user created",{userId:m[0].id,email:e.email,partnerId:e.partnerId,passwordProvided:!c}),{success:!0,user:{id:m[0].id,name:m[0].name,email:m[0].email,phone:m[0].phone,partnerId:m[0].partnerId,languagePreference:m[0].languagePreference,createdAt:m[0].createdAt},password:d,temporaryPassword:c?d:void 0}}catch(r){return l.logger.error("Error creating partner user",{error:r,input:e}),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}[a,s,n,i]=d.then?(await d)():d,e.s(["createPartnerUser",()=>u]),t()}catch(e){t(e)}},!1),19387,e=>e.a(async(r,t)=>{try{var a=e.i(11797),s=e.i(82280),n=e.i(85278),i=e.i(3781),o=e.i(97010),l=r([a,s,n,o]);[a,s,n,o]=l.then?(await l)():l;let u=o.z.object({name:o.z.string().min(2,"Name must be at least 2 characters"),email:o.z.string().email("Invalid email address"),phone:o.z.string().min(10,"Phone must be at least 10 characters").optional(),language:o.z.enum(["en","ar"]).default("en"),sendWelcomeEmail:o.z.boolean().default(!0)});async function d(e,r){if("POST"!==e.method)return r.status(405).json({message:"Method not allowed"});try{let t=e.headers.authorization;if(!t||!t.startsWith("Bearer "))return(0,n.sendErrorResponse)(r,{message:"Authorization header missing or invalid",code:"AUTHENTICATION_ERROR",statusCode:401});let o=t.substring(7),{userId:l}=await a.authService.verifyToken(o),d=await a.authService.getUserProfile(l);if("admin"!==d.userType)return(0,n.sendErrorResponse)(r,{message:"Access denied - Admin required",code:"AUTHORIZATION_ERROR",statusCode:403});let c=parseInt(e.query.id);if(isNaN(c))return(0,n.sendErrorResponse)(r,{message:"Invalid partner ID",code:"VALIDATION_ERROR",statusCode:400});let m=u.parse(e.body),p=await (0,s.createPartnerUser)({partnerId:c,name:m.name,email:m.email,phone:m.phone,language:m.language,sendWelcomeEmail:m.sendWelcomeEmail});if(!p.success)return(0,n.sendErrorResponse)(r,{message:p.error||"Failed to create partner user",code:"USER_CREATION_FAILED",statusCode:400});return i.logger.apiResponse(e.method,e.url,201,0,l,e.headers["x-request-id"]),(0,n.sendSuccessResponse)(r,{message:"Partner user created successfully. Welcome email sent.",user:p.user,temporaryPassword:p.password},201)}catch(a){let t=(0,n.handleApiError)(a);return i.logger.error("Create partner user API error",{error:t.message,code:t.code,requestId:e.headers["x-request-id"]}),(0,n.sendErrorResponse)(r,t)}}e.s(["default",()=>d]),t()}catch(e){t(e)}},!1),29810,e=>e.a(async(r,t)=>{try{var a=e.i(89304),s=e.i(36438),n=e.i(90950),i=e.i(17885),o=e.i(19387),l=e.i(8911),d=e.i(95011),u=e.i(40430),c=r([o]);[o]=c.then?(await c)():c;let p=(0,i.hoist)(o,"default"),h=(0,i.hoist)(o,"config"),g=new n.PagesAPIRouteModule({definition:{kind:s.RouteKind.PAGES_API,page:"/api/admin/partners/[id]/users/create",pathname:"/api/admin/partners/[id]/users/create",bundlePath:"",filename:""},userland:o,distDir:".next",relativeProjectDir:""});async function m(e,r,t){g.isDev&&(0,u.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/admin/partners/[id]/users/create";s=s.replace(/\/index$/,"")||"/";let n=await g.prepare(e,r,{srcPage:s});if(!n){r.statusCode=400,r.end("Bad Request"),null==t.waitUntil||t.waitUntil.call(t,Promise.resolve());return}let{query:i,params:o,prerenderManifest:c,routerServerContext:m}=n;try{let t=e.method||"GET",a=(0,l.getTracer)(),n=a.getActiveScopeSpan(),u=g.instrumentationOnRequestError.bind(g),p=async n=>g.render(e,r,{query:{...i,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:g.isDev,page:"/api/admin/partners/[id]/users/create",internalRevalidate:null==m?void 0:m.revalidate,onError:(...r)=>u(e,...r)}).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let e=a.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=e.get("next.route");if(i){let e=`${t} ${i}`;n.setAttributes({"next.route":i,"http.route":i,"next.span_name":e}),n.updateName(e)}else n.updateName(`${t} ${s}`)});n?await p(n):await a.withPropagatedContext(e.headers,()=>a.trace(d.BaseServerSpan.handleRequest,{spanName:`${t} ${s}`,kind:l.SpanKind.SERVER,attributes:{"http.method":t,"http.target":e.url}},p))}catch(e){if(g.isDev)throw e;(0,a.sendError)(r,500,"Internal Server Error")}finally{null==t.waitUntil||t.waitUntil.call(t,Promise.resolve())}}e.s(["config",0,h,"default",0,p,"handler",()=>m]),t()}catch(e){t(e)}},!1)];

//# sourceMappingURL=projects_ticketing-platform_0e0465cf._.js.map