module.exports=[82280,e=>e.a(async(r,t)=>{try{var a=e.i(29229),n=e.i(88707),i=e.i(78156),s=e.i(89722),o=e.i(56732),l=e.i(3781),u=r([a,n,i,s]);async function d(e){try{let r=await n.db.select().from(i.partners).where((0,s.and)((0,s.eq)(i.partners.id,e.partnerId),(0,s.eq)(i.partners.isActive,!0),(0,s.eq)(i.partners.isDeleted,!1))).limit(1);if(0===r.length)return{success:!1,error:"Partner not found or inactive"};if((await n.db.select().from(i.users).where((0,s.and)((0,s.eq)(i.users.email,e.email),(0,s.eq)(i.users.isDeleted,!1))).limit(1)).length>0)return{success:!1,error:"Email already exists"};let t=await n.db.select().from(i.roles).where((0,s.eq)(i.roles.name,"partner")).limit(1);if(0===t.length)return{success:!1,error:"Partner role not found"};let u=e.password||function(){let e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*",r="";r+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(26*Math.random())],r+="abcdefghijklmnopqrstuvwxyz"[Math.floor(26*Math.random())],r+="0123456789"[Math.floor(10*Math.random())],r+="!@#$%^&*"[Math.floor(8*Math.random())];for(let t=r.length;t<12;t++)r+=e[Math.floor(Math.random()*e.length)];return r.split("").sort(()=>Math.random()-.5).join("")}(),d=await a.default.hash(u,12),m=!e.password,c=await n.db.insert(i.users).values({name:e.name,email:e.email,phone:e.phone||null,password:d,roleId:t[0].id,userType:"partner",partnerId:e.partnerId,languagePreference:e.language||"en",isActive:!0,isDeleted:!1,emailVerifiedAt:new Date,createdAt:new Date}).returning();if(!1!==e.sendWelcomeEmail&&m)try{await o.default.sendWelcomeEmail(e.email,e.name,u,e.language||"en"),l.logger.info("Welcome email sent",{email:e.email,userId:c[0].id})}catch(r){l.logger.error("Failed to send welcome email",{error:r,email:e.email})}return l.logger.info("Partner user created",{userId:c[0].id,email:e.email,partnerId:e.partnerId,passwordProvided:!m}),{success:!0,user:{id:c[0].id,name:c[0].name,email:c[0].email,phone:c[0].phone,partnerId:c[0].partnerId,languagePreference:c[0].languagePreference,createdAt:c[0].createdAt},password:u,temporaryPassword:m?u:void 0}}catch(r){return l.logger.error("Error creating partner user",{error:r,input:e}),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}[a,n,i,s]=u.then?(await u)():u,e.s(["createPartnerUser",()=>d]),t()}catch(e){t(e)}},!1),60901,e=>e.a(async(r,t)=>{try{var a=e.i(11797),n=e.i(88707),i=e.i(78156),s=e.i(89722),o=e.i(85278),l=e.i(3781),u=r([a,n,i,s,o]);async function d(e,r){try{let r=e.headers.authorization;if(!r||!r.startsWith("Bearer "))throw new o.AppError("Authentication required",401,o.ErrorCodes.UNAUTHORIZED);let t=r.substring(7),{userId:n}=await a.authService.verifyToken(t),i=await a.authService.getUserProfile(n);return e.user=i,e.userId=i.id,e.roleId=i.roleId,i}catch(r){throw l.logger.error("Authentication failed",{error:r instanceof Error?r.message:"Unknown error",path:e.url}),r}}async function m(e,r,t){try{e.user&&e.roleId||await d(e,r);let a=e.roleId,u=await n.db.select().from(i.rolePermissions).innerJoin(i.permissions,(0,s.eq)(i.permissions.id,i.rolePermissions.permissionId)).where((0,s.and)((0,s.eq)(i.rolePermissions.roleId,a),(0,s.eq)(i.permissions.name,t),(0,s.eq)(i.rolePermissions.isActive,!0),(0,s.eq)(i.rolePermissions.isDeleted,!1),(0,s.eq)(i.permissions.isActive,!0),(0,s.eq)(i.permissions.isDeleted,!1))).limit(1);if(0===u.length)throw new o.AppError(`Permission denied: ${t} required`,403,o.ErrorCodes.FORBIDDEN);l.logger.info("Permission check passed",{userId:e.userId,roleId:a,permission:t})}catch(r){throw l.logger.error("Permission check failed",{error:r instanceof Error?r.message:"Unknown error",userId:e.userId,permission:t,path:e.url}),r}}[a,n,i,s,o]=u.then?(await u)():u,e.s(["requireAuth",()=>d,"requirePermission",()=>m]),t()}catch(e){t(e)}},!1),95862,e=>e.a(async(r,t)=>{try{var a=e.i(97010),n=r([a]);[a]=n.then?(await n)():n;let i=a.z.object({name:a.z.string().min(2,"Partner name must be at least 2 characters"),contactEmail:a.z.string().email("Invalid email address").optional(),contactPhone:a.z.string().min(10,"Phone number must be at least 10 characters").optional(),logoUrl:a.z.string().url("Invalid logo URL").optional(),status:a.z.enum(["active","inactive","suspended"]).default("active")});i.extend({userName:a.z.string().min(2,"User name must be at least 2 characters"),userEmail:a.z.string().email("Invalid email address"),userPhone:a.z.string().min(10,"Phone must be at least 10 characters"),userPassword:a.z.string().min(8,"Password must be at least 8 characters").optional(),sendWelcomeEmail:a.z.boolean().default(!0)});let s=i.partial(),o=a.z.object({partnerId:a.z.number().int().positive("Partner ID must be positive"),name:a.z.string().min(2,"Branch name must be at least 2 characters"),lat:a.z.number().min(-90).max(90,"Latitude must be between -90 and 90"),lng:a.z.number().min(-180).max(180,"Longitude must be between -180 and 180"),contactName:a.z.string().min(2,"Contact name must be at least 2 characters"),phone:a.z.string().min(10,"Phone number must be at least 10 characters"),address:a.z.string().min(5,"Address must be at least 5 characters"),radiusKm:a.z.number().min(.1).max(100,"Radius must be between 0.1 and 100 km").default(10)});o.partial().omit({partnerId:!0}),a.z.object({branchId:a.z.number().int().positive("Branch ID must be positive"),userId:a.z.number().int().positive("User ID must be positive"),role:a.z.enum(["branch_manager","technician","viewer","admin"]).default("viewer")}),a.z.object({partnerId:a.z.number().int().positive("Partner ID must be positive"),categoryId:a.z.number().int().positive("Category ID must be positive")}),a.z.object({partnerId:a.z.number().int().positive("Partner ID must be positive"),pickupOptionTypeId:a.z.number().int().positive("Pickup option type ID must be positive")});let l=a.z.preprocess(e=>{if(null==e||""===e)return;let r=Number(e);return isNaN(r)?void 0:r},a.z.number().optional()),u=a.z.preprocess(e=>{if(null==e||""===e)return 1;let r=Number(e);return isNaN(r)?1:r},a.z.number()),d=a.z.object({status:a.z.enum(["active","inactive","suspended"]).optional(),categoryId:l.refine(e=>void 0===e||e>0,{message:"Category ID must be positive"}),search:a.z.string().optional(),includeBranches:a.z.preprocess(e=>"true"===e,a.z.boolean().optional()),page:u.refine(e=>e>=1,{message:"Page must be at least 1"}),limit:u.refine(e=>e>=1&&e<=1e3,{message:"Limit must be between 1 and 1000"}),sortBy:a.z.enum(["name","createdAt","updatedAt"]).default("name"),sortOrder:a.z.enum(["asc","desc"]).default("asc")}),m=a.z.object({partnerId:l.refine(e=>void 0===e||e>0,{message:"Partner ID must be positive"}),isActive:a.z.preprocess(e=>"true"===e||"false"!==e&&void 0,a.z.boolean().optional()),search:a.z.string().optional(),lat:a.z.preprocess(e=>{if(null==e||""===e)return;let r=Number(e);return isNaN(r)?void 0:r},a.z.number().optional()),lng:a.z.preprocess(e=>{if(null==e||""===e)return;let r=Number(e);return isNaN(r)?void 0:r},a.z.number().optional()),radiusKm:a.z.preprocess(e=>{if(null==e||""===e)return 10;let r=Number(e);return isNaN(r)?10:r},a.z.number().min(.1).max(100)),page:u.refine(e=>e>=1,{message:"Page must be at least 1"}),limit:u.refine(e=>e>=1&&e<=1e3,{message:"Limit must be between 1 and 1000"}),sortBy:a.z.enum(["name","distance","createdAt"]).default("name"),sortOrder:a.z.enum(["asc","desc"]).default("asc")});e.s(["branchFiltersSchema",0,m,"createBranchSchema",0,o,"createPartnerSchema",0,i,"partnerFiltersSchema",0,d,"updatePartnerSchema",0,s]),t()}catch(e){t(e)}},!1),6420,e=>e.a(async(r,t)=>{try{var a=e.i(95862),n=e.i(18879),i=e.i(60901),s=e.i(85278),o=e.i(3781),l=r([a,n,i,s]);async function u(e,r){try{await (0,i.requireAuth)(e,r),await (0,i.requirePermission)(e,r,"branch_manage");let t=e.userId;if(o.logger.apiRequest(e.method,e.url,null,t,e.headers["x-request-id"]),"GET"===e.method){let i=a.branchFiltersSchema.parse(e.query),l=await n.partnerService.getBranches(i);return o.logger.apiResponse(e.method,e.url,200,0,t,e.headers["x-request-id"]),(0,s.sendSuccessResponse)(r,l)}if("POST"!==e.method)return r.status(405).json({message:"Method not allowed"});{let i=a.createBranchSchema.parse(e.body),l=await n.partnerService.createBranch(i,t);return o.logger.apiResponse(e.method,e.url,201,0,t,e.headers["x-request-id"]),(0,s.sendSuccessResponse)(r,l,201)}}catch(a){let t=(0,s.handleApiError)(a);return o.logger.error("Admin branches API error",{error:t.message,code:t.code,requestId:e.headers["x-request-id"]}),(0,s.sendErrorResponse)(r,t)}}[a,n,i,s]=l.then?(await l)():l,e.s(["default",()=>u]),t()}catch(e){t(e)}},!1),53107,e=>e.a(async(r,t)=>{try{var a=e.i(89304),n=e.i(36438),i=e.i(90950),s=e.i(17885),o=e.i(6420),l=e.i(8911),u=e.i(95011),d=e.i(40430),m=r([o]);[o]=m.then?(await m)():m;let p=(0,s.hoist)(o,"default"),h=(0,s.hoist)(o,"config"),g=new i.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/admin/branches",pathname:"/api/admin/branches",bundlePath:"",filename:""},userland:o,distDir:".next",relativeProjectDir:""});async function c(e,r,t){g.isDev&&(0,d.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/admin/branches";n=n.replace(/\/index$/,"")||"/";let i=await g.prepare(e,r,{srcPage:n});if(!i){r.statusCode=400,r.end("Bad Request"),null==t.waitUntil||t.waitUntil.call(t,Promise.resolve());return}let{query:s,params:o,prerenderManifest:m,routerServerContext:c}=i;try{let t=e.method||"GET",a=(0,l.getTracer)(),i=a.getActiveScopeSpan(),d=g.instrumentationOnRequestError.bind(g),p=async i=>g.render(e,r,{query:{...s,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:m.preview,propagateError:!1,dev:g.isDev,page:"/api/admin/branches",internalRevalidate:null==c?void 0:c.revalidate,onError:(...r)=>d(e,...r)}).finally(()=>{if(!i)return;i.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let e=a.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=e.get("next.route");if(s){let e=`${t} ${s}`;i.setAttributes({"next.route":s,"http.route":s,"next.span_name":e}),i.updateName(e)}else i.updateName(`${t} ${n}`)});i?await p(i):await a.withPropagatedContext(e.headers,()=>a.trace(u.BaseServerSpan.handleRequest,{spanName:`${t} ${n}`,kind:l.SpanKind.SERVER,attributes:{"http.method":t,"http.target":e.url}},p))}catch(e){if(g.isDev)throw e;(0,a.sendError)(r,500,"Internal Server Error")}finally{null==t.waitUntil||t.waitUntil.call(t,Promise.resolve())}}e.s(["config",0,h,"default",0,p,"handler",()=>c]),t()}catch(e){t(e)}},!1),88749,e=>{e.v(e=>Promise.resolve().then(()=>e(85278)))}];

//# sourceMappingURL=projects_ticketing-platform_a111b84a._.js.map